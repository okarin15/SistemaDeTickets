<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Administrador</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --accent: #8b5cf6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --darker: #0f172a;
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --sidebar-width: 260px;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
        }

        /* Tema Claro */
        [data-theme="light"] {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --accent: #8b5cf6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --dark: #f8fafc;
            --dark-light: #e2e8f0;
            --darker: #cbd5e1;
            --text-light: #0f172a;
            --text-muted: #475569;
            --border-color: #cbd5e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark);
            color: var(--text-light);
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--dark-light);
            padding: 20px 0;
            border-right: 1px solid var(--border-color);
            transition: var(--transition);
            position: fixed;
            
            /* AGREGA O ASEGURA ESTAS DOS LÍNEAS: */
            top: 0;
            left: 0;
            
            height: 100vh;
            z-index: 1000;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 1.8rem; /* Un poco más grande */
            font-weight: 800;  /* Letra más gruesa (Bold) */
            margin-bottom: 5px;
            letter-spacing: -0.5px;
            
            /* EL EFECTO DEGRADADO MÁGICO: */
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%); /* Verde a Azul */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo small {
            color: #1f2937; /* Color Gris Oscuro casi negro (para que se lea bien) */
            font-size: 0.9rem; /* Un pelín más grande */
            font-weight: 600;  /* Un poco más gordita la letra */
            display: block;    /* Asegura que quede en su propia línea */
            margin-top: 2px;
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            padding: 12px 20px;
            border-left: 3px solid transparent;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-links li:hover {
            background-color: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--primary);
        }

        .nav-links li.active {
            background-color: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--primary);
        }

        .nav-links a {
            color: var(--text-light);
            text-decoration: none;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .nav-links i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .header h1 {
            font-size: 1.8rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--dark-light);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .user-role {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--dark-light);
            cursor: pointer;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .card h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 15px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .card .value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-light);
            margin-bottom: 8px;
            line-height: 1;
        }

        .card .trend {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .trend.positive {
            color: var(--success);
        }

        .trend.negative {
            color: var(--danger);
        }

        .table-container {
            background-color: var(--dark-light);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 30px;
            transition: var(--transition);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: rgba(30, 41, 59, 0.8);
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: rgba(30, 41, 59, 0.5);
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status.active {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status.inactive {
            background-color: rgba(148, 163, 184, 0.2);
            color: var(--text-muted);
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .status.suspended {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status.pending {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status.completed {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status.in-progress {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        
        /* Estados en español usados por panel de usuario */
        .status.nuevo {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .status.en_progreso {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* Estilo específico para cerrado/completed si no existe */
        .status.completed, .status.closed {
            background-color: rgba(148, 163, 184, 0.2); /* Gris */
            color: #64748b;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        /* Pega esto en tu CSS si no está seguro */
        .status.pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .status.in-progress { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
        .status.completed { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .status.closed { background: rgba(148, 163, 184, 0.2); color: #64748b; border: 1px solid rgba(148, 163, 184, 0.3); }

.role {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role.admin {
            background-color: rgba(139, 92, 246, 0.2);
            color: var(--accent);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .role.user {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .role.tech {
            background-color: rgba(249, 115, 22, 0.2);
            color: #f97316;
            border: 1px solid rgba(249, 115, 22, 0.3);
        }

        .role.support {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btn.edit {
            background: linear-gradient(135deg, var(--warning) 0%, #f97316 100%);
            color: white;
        }

        .action-btn.delete {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        .action-btn.reset {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
        }

        .action-btn.view {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--dark-light);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            transition: var(--transition);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--dark);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            color: var(--text-light);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        .message-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--primary) 100%);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .message-error {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .search-bar {
            display: flex;
            margin-bottom: 0;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 15px;
            background-color: var(--dark-light);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            color: var(--text-light);
            transition: var(--transition);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-select {
            padding: 10px 15px;
            background-color: var(--dark-light);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-light);
            font-size: 0.9rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .chart-container {
            background-color: var(--dark-light);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 25px;
            transition: var(--transition);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-placeholder {
            height: 250px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1rem;
        }

        .priority {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority.high {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .priority.medium {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .priority.low {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Prioridad Crítica (Morado/Violeta para máxima urgencia) */
        .priority.critical, .priority.critica {
            background-color: rgba(139, 92, 246, 0.2); /* Fondo morado suave */
            color: #7c3aed; /* Texto morado fuerte */
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        
        /* Prioridades en español usadas por panel de usuario */
        .priority.alta {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .priority.media {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .priority.baja {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

.settings-group {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-group h3 {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--text-light);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-info h4 {
            font-size: 0.95rem;
            margin-bottom: 4px;
            color: var(--text-light);
        }

        .settings-info p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* === BOTÓN CERRAR SESIÓN === */
        .logout-btn {
            margin-top: 20px;
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            width: calc(100% - 40px);
            margin-left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        /* === ESTILOS PARA PÁGINAS ESPECÍFICAS === */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Estilos para el dashboard - MEJORADO */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--dark-light);
            cursor: pointer;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
            border-top: 4px solid var(--primary);
            transition: var(--transition);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .stat-card h3 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--text-light);
            line-height: 1;
        }
        
        .stat-card p {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin: 0;
        }
        
        /* Estilos para reportes - MEJORADO */
        .report-filters {
            background: var(--dark-light);
            border-radius: var(--border-radius);
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        /* Estilos para configuración - MEJORADO */
        .config-section {
            background: var(--dark-light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .config-section h3 {
            margin-bottom: 15px;
            color: var(--text-light);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 1.1rem;
        }

        /* === ESTILOS PARA GRÁFICOS REALES - MEJORADO === */
        .chart-real {
            width: 100%;
            height: 250px;
            background: transparent;
        }

        .chart-small {
            width: 100% !important;
            height: 180px !important;
            background: transparent;
            position: relative;
        }

        /* Grid para gráficos en reportes - MEJORADO */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: var(--dark-light);
            border-radius: var(--border-radius);
            padding: 18px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .chart-card:hover {
            transform: translateY(-3px);
        }

        .chart-card h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--text-light);
            text-align: center;
        }

        .chart-container-fixed {
            position: relative;
            width: 100%;
            height: 180px;
            margin: 0 auto;
        }

        /* Asegurar que los canvas tengan dimensiones fijas */
        #statusChart, #priorityChart {
            width: 100% !important;
            height: 180px !important;
            display: block;
        }

        /* === ESTILOS PARA RESUMEN DEL SISTEMA === */
        .system-summary {
            background: var(--dark-light);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
            cursor: pointer;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .summary-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
        }

        .summary-item i {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .summary-item h4 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-light);
        }

        /* === ESTILOS PARA MODALES === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark-light);
            border-radius: var(--border-radius);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        /* === ESTILOS PARA NOTIFICACIONES === */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: var(--box-shadow);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success) 0%, var(--primary) 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #f97316 100%);
        }

        /* === ESTILOS PARA EL SWITCH DE TEMA === */
        .theme-switch {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none; /* oculto: solo modo claro */
        }

        .theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        /* === RESPONSIVE  === */

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .table-container {
                overflow-x: auto;
                margin-bottom: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
                margin-bottom: 20px;
            }
            
            .search-bar {
                width: 100%;
                flex-direction: column;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .chart-real {
                height: 200px;
            }

            .chart-small {
                height: 160px;
            }

            .stat-card {
                padding: 15px;
                min-height: 120px;
            }

            .stat-card h3 {
                font-size: 1.5rem;
            }

            .summary-item {
                padding: 12px;
            }

            .summary-item .value {
                font-size: 1.3rem;
            }

            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 15px;
                right: 15px;
                z-index: 1001;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: var(--border-radius);
                padding: 8px 12px;
                font-size: 1.1rem;
                cursor: pointer;
            }
        }

        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .stat-card {
                min-height: 110px;
                padding: 12px;
            }
            
            .stat-card i {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .stat-card h3 {
                font-size: 1.3rem;
            }
            
            .stat-card p {
                font-size: 0.8rem;
            }
            
            .summary-item {
                padding: 10px;
            }
            
            .summary-item i {
                font-size: 1.5rem;
            }
            
            .summary-item .value {
                font-size: 1.2rem;
            }
        }

        /* === SCROLLBAR PERSONALIZADO === */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* === CORRECCIÓN VISUAL: ELIMINAR CAJAS RARAS === */
        /* Esto fuerza a ocultar cualquier cuadro generado por el atributo title */
        [title]:after, 
        [title]:before {
            content: none !important;
            display: none !important;
            border: none !important;
            background: none !important;
        }
        
        /* Asegurar que los botones se vean limpios */
        .action-buttons .action-btn {
            position: relative; /* Evita conflictos de posición */
        }
        
    [title]:after, 
    [title]:before {
        content: none !important;
        display: none !important;
        border: none !important;
    }

    /* 2. ALINEAR BUSCADOR Y FILTROS */
    .filter-container {
        display: flex;
        align-items: center !important; /* Centra verticalmente */
        flex-wrap: wrap;
        gap: 10px;
    }

    /* Forzar que el input de búsqueda y los select tengan EXACTAMENTE la misma altura */
    .search-bar input,
    .filter-select,
    .btn {
        height: 42px !important;       /* Altura fija para todos */
        line-height: normal !important; /* Evita desplazamientos de texto */
        box-sizing: border-box !important;
        margin: 0 !important;
        display: inline-flex;
        align-items: center;
    }

    /* Ajuste específico para el input de texto para que no se vea hundido */
    .search-bar input {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }

    /* === ARREGLO VISUAL TABLA REPORTES === */
    #reportTable thead th {
        background-color: var(--primary-dark) !important; /* Verde oscuro elegante */
        color: white !important;
        border-bottom: 2px solid var(--primary);
        text-transform: uppercase;
        font-size: 0.85rem;
        padding: 15px;
    }

    #reportTable tbody td {
        background-color: var(--dark-light); /* Fondo oscuro acorde al tema */
        color: var(--text-light);
        border-bottom: 1px solid var(--border-color);
        padding: 15px;
        font-size: 0.95rem;
    }

    /* =========================================
       UNIFICACIÓN DE TABLAS (ESTILO VERDE)
       Aplica a: Dashboard, Tickets, Categorías y Usuarios
       ========================================= */
    
    .table-container table th {
        background-color: var(--primary-dark) !important; /* El mismo verde oscuro de reportes */
        color: white !important;                          /* Texto blanco */
        border-bottom: 3px solid var(--primary) !important; /* Línea verde brillante abajo */
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.5px;
        padding: 15px 20px !important;
    }

    /* Opcional: Efecto hover en las filas para que combine */
    .table-container table tbody tr:hover {
        background-color: rgba(16, 185, 129, 0.05) !important; /* Verde muy suave al pasar el mouse */
    }
    
/* Estilo para la tabla de historial en el modal */
#ticketHistoryBody tr {
    border-bottom: 1px solid #e2e8f0;
}
#ticketHistoryBody td {
    padding: 8px 10px;
    font-size: 0.9rem;
    color: #334155;
}
#ticketHistoryBody tr:last-child {
    border-bottom: none;
}

    /* =========================================
       CABECERAS DE TABLA VERDES (DISEÑO UNIFICADO)
       ========================================= */
    
    /* Esto afecta a todas las tablas: Usuarios, Tickets, Categorías, etc. */
    th {
        background: linear-gradient(135deg, var(--primary-dark) 0%, #047857 100%) !important;
        color: white !important;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.85rem;
        border-bottom: 3px solid var(--primary) !important;
        padding: 15px !important;
    }

    /* Opcional: Cambiar el color de fondo de las filas al pasar el mouse */
    tbody tr:hover {
        background-color: rgba(16, 185, 129, 0.1) !important; /* Verde muy suave */
        transform: scale(1.005); /* Pequeño efecto de zoom elegante */
        transition: all 0.2s ease;
    }

    /* === ESTILO ESPECÍFICO PARA LA BITÁCORA (MODAL) === */
    /* Esto hace que la tablita del historial no use el verde gigante */
    
    #ticketHistoryBody tr {
        background-color: transparent !important; /* Quita el fondo verde del hover */
    }
    
    /* Encabezados pequeños y grises para el historial */
    .form-group table th {
        background: #f1f5f9 !important; /* Gris suave */
        color: #64748b !important;      /* Texto gris */
        border-bottom: 1px solid #cbd5e1 !important;
        padding: 8px !important;        /* Más compacto */
        font-size: 0.75rem;
    }
    
    .form-group table td {
        padding: 8px !important;
        font-size: 0.85rem;
        border-bottom: 1px solid #e2e8f0;
    }

    /* === ESTILOS DE PAGINACIÓN MINIMALISTA === */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: var(--dark-light); /* Mismo fondo que la tabla */
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
    }

    .pagination-info {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .pagination-controls {
        display: flex;
        gap: 5px;
    }

    .page-btn {
        padding: 5px 12px;
        border: 1px solid var(--border-color);
        background: transparent;
        color: var(--text-light);
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.85rem;
        transition: all 0.2s;
    }

    .page-btn:hover:not(.disabled) {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--primary);
        color: var(--primary);
    }

    .page-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .page-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    </style>
</head>
<body data-theme="light">
    <!-- Switch de tema -->
    <div class="theme-switch">
        <button class="theme-btn" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <!-- Sistema de Administración Completo -->
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h1>Sistema de Tickets</h1>
                <small>Panel Administrador</small>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="#" onclick="showPage('dashboard')"><i class="fas fa-chart-bar"></i> Dashboard</a></li>
                <li><a href="#" onclick="showPage('tickets')"><i class="fas fa-ticket-alt"></i> Gestionar Tickets</a></li>
                <li><a href="#" onclick="showPage('areas')"><i class="fas fa-building"></i> Gestionar Áreas</a></li>
                <li><a href="#" onclick="showPage('categorias')"><i class="fas fa-tags"></i> Gestionar Categorías</a></li>
                <li><a href="#" onclick="showPage('usuarios')"><i class="fas fa-users"></i> Gestionar Usuarios</a></li>
                <li><a href="#" onclick="showPage('reportes')"><i class="fas fa-chart-pie"></i> Reportes</a></li>
                <li><a href="#" onclick="showPage('leaderboard')"><i class="fas fa-trophy"></i> Ranking Técnicos</a></li>
                <li><a href="#" onclick="showPage('configuracion')"><i class="fas fa-cog"></i> Configuración</a></li>
                <li><a href="#" onclick="showPage('faq')"><i class="fas fa-question-circle"></i> FAQs</a></li>
            </ul>
            
            <form method="post" action="{% url 'logout' %}" style="margin-top: auto; width: 100%;">
                {% csrf_token %}
                <button type="submit" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Cerrar Sesión
                </button>
            </form>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 id="pageTitle">Dashboard del Sistema</h1>
                <div class="user-info">
                    <div class="avatar">
                        A
                    </div>
                    <div class="user-details">
                        <div class="user-name">admin</div>
                        <div class="user-role">Administrador</div>
                    </div>
                </div>
            </div>

            <!-- Contenedor de páginas -->
            <div id="pageContainer">
                <!-- Página: Dashboard - MEJORADA (SIN ACTIVIDAD DE TICKETS) -->
                <div id="dashboard-page" class="page-content active">
                    <!-- Estadísticas Rápidas - TAMAÑOS OPTIMIZADOS -->
                    <div class="dashboard-stats">
                        <div class="stat-card" id="cardTotalTickets">
                            <i class="fas fa-ticket-alt"></i>
                            <h3 id="totalTicketsStat">147</h3>
                            <p>Tickets Totales</p>
                        </div>
                        <div class="stat-card" id="cardPendingTickets">
                            <i class="fas fa-clock"></i>
                            <h3 id="pendingTicketsStat">24</h3>
                            <p>Pendientes</p>
                        </div>
                        <div class="stat-card" id="cardResolvedTickets">
                            <i class="fas fa-check-circle"></i>
                            <h3 id="resolvedTicketsStat">103</h3>
                            <p>Resueltos</p>
                        </div>
                        <div class="stat-card" id="cardCriticalTickets">
                            <i class="fas fa-exclamation-triangle" style="color: var(--primary);"></i> <h3 id="criticalTicketsStat">0</h3>
                            <p>Tickets Críticos</p>
                        </div>
                    </div>

                    <!-- Resumen del Sistema  -->
                    <div class="system-summary">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.2rem; color: var(--text-light);">Métricas de Eficiencia</h3>
                        <div class="summary-grid">
                            
                            <div class="summary-item">
                                <i class="fas fa-chart-line"></i>
                                <h4>Tasa de Resolución</h4>
                                <div class="value" id="summaryResolution">0%</div>
                            </div>

                            <div class="summary-item">
                                <i class="fas fa-bolt"></i>
                                <h4>Respuesta Promedio</h4>
                                <div class="value" id="summaryAvgTime">-</div>
                            </div>

                            <div class="summary-item">
                                <i class="fas fa-smile"></i>
                                <h4>Satisfacción</h4>
                                <div class="value" id="summarySatisfaction">-</div>
                            </div>

                            <div class="summary-item" id="summaryAgents" style="cursor: pointer;">
    <i class="fas fa-headset" style="color: var(--primary);"></i> <h4>Agentes Soporte</h4>
    <div class="value" id="summaryAgentsVal">0</div>
</div>
                        </div>
                    </div>

                    <!-- Tickets Recientes -->
                    <div class="table-container">
                        <div class="table-header" style="padding: 18px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-light);">Tickets Recientes</h3>
                            <div class="table-actions">
                                <button class="btn btn-primary" onclick="showPage('tickets')" style="padding: 8px 15px; font-size: 0.85rem;">
                                    <i class="fas fa-list"></i> Ver Todos
                                </button>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>TÍTULO</th>
                                    <th>ÁREA</th>
                                    <th>Usuario</th>
                                    <th>Prioridad</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>AGENTE</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="recentTicketsBody">
                                <!-- Tickets recientes se cargan aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Página: Gestión de Tickets -->
                <div id="tickets-page" class="page-content">
<div class="cards-container">
    <div class="card" id="ticketsOpenCard">
        <h3>Tickets Abiertos (Pendientes)</h3>
        <div class="value" id="openTickets">0</div>
        </div>
    <div class="card" id="ticketsResponseTimeCard">
        <h3>Tiempo Promedio Respuesta</h3>
        <div class="value" id="avgResponseTime">-</div>
        </div>
    <div class="card" id="ticketsResolvedCard">
        <h3>Tickets Resueltos</h3>
        <div class="value" id="resolvedTicketsCardValue">0</div>
        </div>
    <div class="card" id="ticketsSatisfactionCard">
        <h3>Satisfacción</h3>
        <div class="value" id="satisfactionRate">-</div>
        </div>
</div>

                    <div class="filter-container">
                        <div class="search-bar">
                            <input type="text" id="ticketSearch" placeholder="Buscar tickets...">
                        </div>
                        <select class="filter-select" id="ticketStatusFilter">
                            <option value="">Todos los estados</option>
                            <option value="pending">Nuevo</option>
                            <option value="in-progress">En Progreso</option>
                            <option value="completed">Resuelto</option>
                            <option value="closed">Cerrado</option>
                        </select>
                        <select class="filter-select" id="ticketPriorityFilter">
                            <option value="">Todas las prioridades</option>
                            <option value="critical">Crítica</option>
                            <option value="high">Alta</option>
                            <option value="medium">Media</option>
                            <option value="low">Baja</option>
                        </select>
                        <select class="filter-select" id="ticketAreaFilter">
                            <option value="">Todas las áreas</option>
                        </select>
                        <button class="btn btn-secondary" id="newTicketBtn">
                            <i class="fas fa-plus"></i> Nuevo Ticket
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Título</th>
                                    <th>Área</th>
                                    <th>Usuario</th>
                                    <th>Prioridad</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Agente</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ticketsTableBody">
                                <!-- Tickets se cargan aquí dinámicamente -->
                            </tbody>
                        </table>
                        <div id="ticketsPagination" class="pagination-container"></div>
                    </div>
                </div>

                <!-- Página: Gestión de Áreas -->
                <div id="areas-page" class="page-content">
                    <div class="header-actions" style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openAreaModal()">
                            <i class="fas fa-plus"></i> Nueva Área
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <tbody id="areasBody"></tbody>
                        </table>
                    </div>
                </div>


                <div id="categorias-page" class="page-content">
                    <div class="header-actions" style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openCategoryModal()">
                            <i class="fas fa-plus"></i> Nueva Categoría
                        </button>
                    </div>
                
                    <div class="table-container">
                        <table>
                            <tbody id="categoriasBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <!-- Página: Gestión de Usuarios -->
                <div id="usuarios-page" class="page-content">
                    <!-- Contenido de gestión de usuarios (el código original) -->
                    <div id="messageContainer"></div>

                    <!-- Acciones Rápidas -->
                    <div class="card" style="margin-bottom: 30px;">
                        <h3>Acciones de Usuario</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="createUserBtn" onclick="openUserModal()">
                                <i class="fas fa-user-plus"></i> Crear Nuevo Usuario
                            </button>
                        </div>
                    </div>

                    <!-- Filtros y Búsqueda -->
                    <div class="filter-container">
                        <div class="search-bar">
                            <input type="text" id="searchInput" placeholder="Buscar usuarios por nombre, email o usuario...">
                        </div>
                        <select class="filter-select" id="filterRole">
                            <option value="">Todos los roles</option>
                            <option value="admin">Administrador</option>
                            <option value="user">Usuario</option>
                            <option value="tech">Técnico</option> 
                        </select>
                        <select class="filter-select" id="filterStatus">
                            <option value="">Todos los estados</option>
                            <option value="active">Activo</option>
                            <option value="inactive">Inactivo</option>
                            <option value="suspended">Suspendido</option>
                        </select>
                    </div>

                    <!-- Tabla de Usuarios -->
                    <div class="table-container">
                        <div class="table-header" style="padding: 18px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-light);">Todos los Usuarios del Sistema</h3>
                            <div class="table-actions">
                                <button class="btn btn-primary" id="refreshBtn">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                            </div>
                        </div>
                        
                        <div id="usersTable">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th>Estado</th>
                                        <th>Fecha Registro</th>
                                        <th>Último Acceso</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usersBody">
                                    <!-- Los usuarios se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                            <div id="usersPagination" class="pagination-container"></div>
                        </div>

                        <!-- Estado vacío -->
                        <div id="emptyState" style="text-align: center; padding: 50px 20px; color: var(--text-muted); display: none;">
                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <h3 style="font-size: 1.3rem; margin-bottom: 8px; color: var(--text-light);">No hay usuarios en el sistema</h3>
                            <p style="font-size: 0.9rem;">Comienza creando el primer usuario</p>
                            <button class="btn btn-primary" style="margin-top: 15px; padding: 10px 20px;" id="createFirstUserBtn">
                                <i class="fas fa-user-plus"></i> Crear Primer Usuario
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Página: Reportes - MEJORADA -->
                <div id="reportes-page" class="page-content">
                    <div class="report-filters">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">Filtros de Reporte</h3>
                        <div class="filter-container" style="gap: 10px; align-items: flex-end;">
                            
                            <div style="display:flex; gap:5px;">
                                <input type="date" class="filter-select" id="startDate" title="Fecha Inicio">
                                <input type="date" class="filter-select" id="endDate" title="Fecha Fin">
                            </div>

                            <select class="filter-select" id="reportCategoryFilter" style="min-width: 150px;">
                                <option value="">Todas las Categorías</option>
                                </select>

                            <select class="filter-select" id="reportPriorityFilter" style="min-width: 140px;">
                                <option value="">Todas las Prioridades</option>
                                <option value="critical">Crítica</option>
                                <option value="high">Alta</option>
                                <option value="medium">Media</option>
                                <option value="low">Baja</option>
                            </select>
                            
                            <select class="filter-select" id="reportTechFilter" style="min-width: 150px;">
                                <option value="">Todos los Técnicos</option>
                                </select>

                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="generateReport()">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                                
                                <button class="btn btn-success" onclick="exportToExcel()" style="background: #10b981; color: white;">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>

                                <button class="btn btn-danger" onclick="exportToPDF()" style="background: #ef4444; color: white; display: inline-flex; align-items: center;">
                                    <i class="fas fa-file-pdf" style="margin-right: 5px;"></i> PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gráficos en grid optimizado -->
                    <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        
                        <div class="chart-card" style="background: white; padding: 25px; border-radius: 6px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);">
                            <h3 style="margin-bottom: 20px; color: #334155; font-size: 1rem; font-weight: 700;">Distribución por Estado</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                                    <span style="color:#64748b;">Pendientes</span>
                                    <span style="font-weight:700; color:#0f172a;" id="barCountPending">0</span>
                                </div>
                                <div style="width:100%; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                                    <div id="barWidthPending" style="width:0%; height:100%; background:#0ea5e9; transition: width 1s;"></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                                    <span style="color:#64748b;">En Progreso</span>
                                    <span style="font-weight:700; color:#0f172a;" id="barCountProgress">0</span>
                                </div>
                                <div style="width:100%; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                                    <div id="barWidthProgress" style="width:0%; height:100%; background:#f59e0b; transition: width 1s;"></div>
                                </div>
                            </div>

                            <div>
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                                    <span style="color:#64748b;">Resueltos/Cerrados</span>
                                    <span style="font-weight:700; color:#0f172a;" id="barCountResolved">0</span>
                                </div>
                                <div style="width:100%; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                                    <div id="barWidthResolved" style="width:0%; height:100%; background:#10b981; transition: width 1s;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="chart-card" style="background: white; padding: 25px; border-radius: 6px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);">
                            <h3 style="margin-bottom: 20px; color: #334155; font-size: 1rem; font-weight: 700;">Nivel de Prioridad</h3>

                            <div style="margin-bottom: 15px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                                    <span style="color:#64748b;">Alta / Crítica</span>
                                    <span style="font-weight:700; color:#ef4444;" id="barCountHigh">0</span>
                                </div>
                                <div style="width:100%; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                                    <div id="barWidthHigh" style="width:0%; height:100%; background:#ef4444; transition: width 1s;"></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                                    <span style="color:#64748b;">Media</span>
                                    <span style="font-weight:700; color:#0f172a;" id="barCountMedium">0</span>
                                </div>
                                <div style="width:100%; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                                    <div id="barWidthMedium" style="width:0%; height:100%; background:#f59e0b; transition: width 1s;"></div>
                                </div>
                            </div>

                            <div>
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                                    <span style="color:#64748b;">Baja</span>
                                    <span style="font-weight:700; color:#0f172a;" id="barCountLow">0</span>
                                </div>
                                <div style="width:100%; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                                    <div id="barWidthLow" style="width:0%; height:100%; background:#10b981; transition: width 1s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-header" style="padding: 18px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-light);" id="reportTableTitle">Reporte de Actividad</h3>
                        </div>
                        <table id="reportTable">
                            <thead>
                                <tr>
                                    <th>Período</th>
                                    <th>Tickets Creados</th>
                                    <th>Tickets Resueltos</th>
                                    <th>Tiempo Promedio</th>
                                    <th>Satisfacción</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                <!-- Datos del reporte se cargan aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="configuracion-page" class="page-content">
                    <div class="config-section">
                        <h3>Estado del Sistema</h3>
                        
                        <div class="settings-item">
                            <div class="settings-info">
                                <h4><i class="fas fa-envelope" style="color: var(--primary);"></i> Servidor de Correos</h4>
                                <p>Conectado a Gmail SMTP (soporte.coyahue@gmail.com)</p>
                            </div>
                            <span class="status active" style="background:rgba(16,185,129,0.1); color:#10b981; padding:5px 10px; border-radius:4px;">ACTIVO</span>
                        </div>

                        <div class="settings-item">
                            <div class="settings-info">
                                <h4><i class="fas fa-database" style="color: var(--secondary);"></i> Base de Datos</h4>
                                <p>PostgreSQL (Producción)</p>
                            </div>
                            <span class="status active" style="background:rgba(16,185,129,0.1); color:#10b981; padding:5px 10px; border-radius:4px;">CONECTADO</span>
                        </div>

                        <div class="settings-item">
                            <div class="settings-info">
                                <h4><i class="fas fa-shield-alt" style="color: var(--danger);"></i> Seguridad</h4>
                                <p>Protección CSRF y Autenticación Django activa</p>
                            </div>
                            <span class="status active" style="background:rgba(16,185,129,0.1); color:#10b981; padding:5px 10px; border-radius:4px;">SEGURO</span>
                        </div>
                    </div>
                </div>

                <div id="leaderboard-page" class="page-content">
                    <div class="header-actions" style="margin-bottom: 25px;">
                        <h3><i class="fas fa-trophy" style="color: #fbbf24;"></i> </h3>
                        <p style="color: var(--text-muted);">Evaluación basada en tickets resueltos, velocidad y calificación de usuarios.</p>
                    </div>
                
                    <div class="cards-container" id="podiumContainer" style="margin-bottom: 40px;">
                        </div>
                
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;">Rank</th>
                                    <th>Técnico</th>
                                    <th style="text-align: center;">Tickets Resueltos</th>
                                    <th style="text-align: center;">Tiempo Promedio</th>
                                    <th style="text-align: center;">Satisfacción (Estrellas)</th>
                                    <th style="text-align: center;">Puntaje Total</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <!-- Página: FAQs -->
                <div id="faq-page" class="page-content">
                    <div class="header-actions" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        
                        <button class="btn btn-primary" onclick="openFaqModal()">
                            <i class="fas fa-plus"></i> Nueva Pregunta
                        </button>
                    </div>
                    <div class="config-section">
                        <div id="faqContainer">
                            <!-- Las FAQs se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar usuario -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <button class="modal-close" id="closeUserModal" onclick="closeUserModal()">&times;</button>
            <h2 id="userModalTitle" style="font-size: 1.3rem; margin-bottom: 20px;">Crear Nuevo Usuario</h2><form id="userForm" method="POST" action="{% url 'guardar_usuario' %}">
                {% csrf_token %}
                <input type="hidden" id="userId" name="user_id">
                
                <div class="form-group">
                    <label>Nombre de Usuario (Login)</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" class="form-control" id="fullName" name="nombre">
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label>Rol</label>
                    <select class="form-control" id="userRole" name="rol" required>
                        <option value="user">Usuario Solicitante</option>
                        <option value="tech">Técnico de Soporte</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" class="form-control" id="password" name="password">
                    <small class="text-muted" id="passHelp" style="display:none; color: #94a3b8; font-size: 0.8rem; margin-top: 5px;">
                        Dejar en blanco para mantener la contraseña actual.
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="closeUserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para crear ticket -->
    <div class="modal" id="ticketModal">
        <div class="modal-content">
            <button class="modal-close" id="closeTicketModal" onclick="closeTicketModal()">&times;</button>
            <h2 id="ticketModalTitle" style="font-size: 1.3rem; margin-bottom: 20px;">Crear Nuevo Ticket</h2>
            <form id="ticketForm" onsubmit="handleTicketSubmit(event)">
                <div class="form-group">
                    <label>Título del Ticket</label>
                    <input type="text" class="form-control" id="ticketTitle" required style="padding: 10px 12px;">
                </div>
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea class="form-control" id="ticketDescription" rows="4" required style="padding: 10px 12px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Área Afectada</label>
                    <p id="modalTicketArea" style="font-weight: 600; color: var(--text-light);"></p>
                </div>
                <div class="form-group">
                    <label>Prioridad</label>
                    <select class="form-control" id="ticketPriority" required style="padding: 10px 12px;">
                        <option value="low">Baja</option>
                        <option value="medium">Media</option>
                        <option value="high">Alta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="ticketStatusField" required style="padding: 10px 12px;">
                        <option value="pending">Pendiente</option>
                        <option value="in-progress">En Progreso</option>
                        <option value="completed">Resuelto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Usuario Asignado</label>
                    <select class="form-control" id="assignedUser" style="padding: 10px 12px;">
                        <option value="">Sin asignar</option>
                        <!-- Opciones de usuarios se cargan dinámicamente -->
                    </select>
                </div>

                <div class="form-group">
                    <label>Bitácora de Cambios</label>
                    <div style="background: #f1f5f9; padding: 10px; border-radius: 6px; max-height: 150px; overflow-y: auto;">
                        <table style="width: 100%; font-size: 0.85rem;">
                            <thead>
                                <tr style="text-align: left; color: #64748b;">
                                    <th>Fecha</th>
                                    <th>Usuario</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="ticketHistoryBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" id="cancelTicketBtn" onclick="closeTicketModal()" style="padding: 10px 20px;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveTicketBtn" style="padding: 10px 20px;">Guardar Ticket</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCategoryModal()">×</button>
            <h2 id="categoryModalTitle">Nueva Categoría</h2>
            <form id="categoryForm" method="POST" action="{% url 'guardar_categoria' %}">
                {% csrf_token %} <input type="hidden" id="catId" name="cat_id">
                
                <div class="form-group">
                    <label>Nombre de Categoría</label>
                    <input type="text" class="form-control" id="catNombre" name="nombre" required>
                </div>
                
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea class="form-control" id="catDescripcion" name="descripcion" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="catActivo" name="activo">
                        <option value="true">Activa</option>
                        <option value="false">Inactiva</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="closeCategoryModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="areaModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAreaModal()">×</button>
            <h2 id="areaModalTitle">Nueva Área</h2>
            <form id="areaForm" method="POST" action="{% url 'guardar_area' %}">
                {% csrf_token %}
                <input type="hidden" name="area_id" id="areaId">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" class="form-control" name="nombre" id="areaNombre" required>
                </div>
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea class="form-control" name="descripcion" id="areaDescripcion"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="closeAreaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="faqModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeFaqModal()">×</button>
            <h2 id="faqModalTitle">Nueva Pregunta</h2>
            <form action="{% url 'guardar_faq' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="faq_id" id="faqId">
                <div class="form-group">
                    <label>Pregunta</label>
                    <input type="text" class="form-control" name="pregunta" id="faqPregunta" required>
                </div>
                <div class="form-group">
                    <label>Respuesta</label>
                    <textarea class="form-control" name="respuesta" id="faqRespuesta" rows="4" required></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="closeFaqModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Notificaciones -->
    <div class="notification" id="notification"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ===== SISTEMA COMPLETO DE ADMINISTRACIÓN =====
        
        // ===== DATOS REALES DESDE DJANGO (CORREGIDO) =====
        // El filtro |default:"[]" asegura que nunca quede el espacio vacío
        const masterUsers = {{ users_json|default:"[]"|safe }};
        const masterTickets = {{ tickets_json|default:"[]"|safe }};
        const masterCategories = {{ categorias_json|default:"[]"|safe }};
        const masterAreas = {{ areas_json|default:"[]"|safe }};
        const masterFaqs = {{ faqs_json|default:"[]"|safe }};
        
        // Variables de trabajo
        let currentUsers = [...masterUsers];
        let currentTickets = [...masterTickets];
        let currentReportTickets = [...masterTickets]; // Datos filtrados para reportes/Excel
        let currentTheme = 'light';
        let charts = {};

        // ===== CONFIGURACIÓN DE PAGINACIÓN =====
        const ITEMS_PER_PAGE = 10; // El gerente quiere ver de 10 en 10
        let currentPage = {
            tickets: 1,
            users: 1,
            areas: 1,
            categorias: 1
        };

        // Función Genérica para Paginar Datos
        function paginateData(data, page) {
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            return data.slice(start, end);
        }

        // Función Genérica para Dibujar Controles
        function renderPaginationControls(totalItems, page, containerId, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            
            // Si no hay páginas, limpiar
            if (totalPages <= 1) {
                container.innerHTML = '';
                container.style.display = 'none'; // Ocultar si es poco
                return;
            }
            container.style.display = 'flex';

            let buttonsHtml = '';
            
            // Botón Anterior
            buttonsHtml += `<button class="page-btn ${page === 1 ? 'disabled' : ''}" onclick="changePage('${type}', ${page - 1})">Anterior</button>`;

            // Números (Lógica simplificada: Muestra todos o limitar si son muchos)
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= page - 1 && i <= page + 1)) {
                     buttonsHtml += `<button class="page-btn ${i === page ? 'active' : ''}" onclick="changePage('${type}', ${i})">${i}</button>`;
                } else if (i === page - 2 || i === page + 2) {
                    buttonsHtml += `<span style="margin:0 5px;">...</span>`;
                }
            }

            // Botón Siguiente
            buttonsHtml += `<button class="page-btn ${page === totalPages ? 'disabled' : ''}" onclick="changePage('${type}', ${page + 1})">Siguiente</button>`;

            const startInfo = (page - 1) * ITEMS_PER_PAGE + 1;
            const endInfo = Math.min(page * ITEMS_PER_PAGE, totalItems);

            container.innerHTML = `
                <div class="pagination-info">Mostrando ${startInfo}-${endInfo} de ${totalItems} registros</div>
                <div class="pagination-controls">${buttonsHtml}</div>
            `;
        }

        // Función para cambiar de página
        function changePage(type, newPage) {
            const totalItems = getTypeTotal(type); // Necesitamos saber el total para validar
            const maxPage = Math.ceil(totalItems / ITEMS_PER_PAGE);
            
            if (newPage < 1 || newPage > maxPage) return;
            
            currentPage[type] = newPage;
            
            // Recargar la tabla correspondiente
            if (type === 'tickets') updateTicketsTable();
            if (type === 'users') { 
                // Para usuarios es especial porque tienes filtrado
                displayUsers(currentUsers); 
            }
            if (type === 'areas') loadAreasData();
            if (type === 'categorias') loadCategoriesData();
        }

        // Auxiliar para obtener total según tipo
        function getTypeTotal(type) {
            if (type === 'tickets') return currentTickets.length;
            if (type === 'users') return currentUsers.length;
            if (type === 'areas') return masterAreas.length;
            if (type === 'categorias') return masterCategories.length;
            return 0;
        }

        // Inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log("Iniciando App...");
            
            // 1. Cargar datos
            loadInitialData();
            
            // 2. Configurar eventos
            setupEventListeners();
            
            // 3. Leer URL para saber qué pestaña abrir
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            console.log("Pestaña detectada en URL:", tab);
            
            if (tab) {
                showPage(tab);
                // Limpiar URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                showPage('dashboard');
            }
            
            applyTheme(currentTheme);
        }

        function loadInitialData() {
            // Solo llamamos a las funciones de carga
            // (Las variables master ya están listas desde el inicio)
            
            if (typeof loadUsersData === 'function') loadUsersData();
            if (typeof loadTicketsData === 'function') loadTicketsData();
            if (typeof updateDashboardStats === 'function') updateDashboardStats();
            populateAreaFilter();
        }

        // Llena el selector de áreas para filtrar tickets
        function populateAreaFilter() {
            const select = document.getElementById('ticketAreaFilter');
            if (!select) return;

            // Reset con la opción por defecto
            select.innerHTML = '<option value="">Todas las áreas</option>';

            if (masterAreas && masterAreas.length > 0) {
                masterAreas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.nombre;
                    option.textContent = area.nombre;
                    select.appendChild(option);
                });
            }
        }

                    const statusFilter = document.getElementById('filterStatus');
        function setupEventListeners() {
            // ==========================================
            // 1. FILTROS DE USUARIOS (Reconexión)
            // ==========================================
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // El evento 'input' es el que permite filtrar mientras escribes
                searchInput.addEventListener('input', applyUserFilters);
            }
            
            const filterRole = document.getElementById('filterRole');
            if (filterRole) {
                filterRole.addEventListener('change', applyUserFilters);
            }
            
            const filterStatus = document.getElementById('filterStatus');
            if (filterStatus) {
                filterStatus.addEventListener('change', applyUserFilters);
            }

            // ==========================================
            // 2. FILTROS DE TICKETS (Reconexión)
            // ==========================================
            const ticketSearch = document.getElementById('ticketSearch');
            if (ticketSearch) {
                // Aquí reconectamos la búsqueda en tiempo real de tickets
                ticketSearch.addEventListener('input', applyTicketFilters);
            }
            
            const ticketStatusFilter = document.getElementById('ticketStatusFilter');
            if (ticketStatusFilter) {
                ticketStatusFilter.addEventListener('change', applyTicketFilters);
            }
            
            const ticketPriorityFilter = document.getElementById('ticketPriorityFilter');
            if (ticketPriorityFilter) {
                ticketPriorityFilter.addEventListener('change', applyTicketFilters);
            }
            
            const ticketAreaFilter = document.getElementById('ticketAreaFilter');
            if (ticketAreaFilter) {
                ticketAreaFilter.addEventListener('change', applyTicketFilters);
            }

            // ==========================================
            // 3. BOTONES VARIOS
            // ==========================================
            
            // Navegación Móvil
            const mobileBtn = document.getElementById('mobileMenuBtn');
            if (mobileBtn) mobileBtn.addEventListener('click', toggleMobileMenu);
            
            // Tema
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
            
            // Modales (Crear Usuario / Ticket)
            const createUserBtn = document.getElementById('createUserBtn');
            if (createUserBtn) createUserBtn.addEventListener('click', () => openUserModal());
            
            const newTicketBtn = document.getElementById('newTicketBtn');
            if (newTicketBtn) newTicketBtn.addEventListener('click', () => openTicketModal());

            // Botones de Reportes
            const generateReportBtn = document.getElementById('generateReportBtn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', () => generateReport(false));
            }
            
            // Refrescar tablas
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) refreshBtn.addEventListener('click', refreshUsers);

            // === EVENTOS CLIC PARA TARJETAS DE USUARIOS ===

            // 1. Tarjeta "Total Usuarios" -> Limpia todos los filtros (Ver todos)
            const cardTotalUsers = document.getElementById('usersTotalCard');
            if (cardTotalUsers) {
                cardTotalUsers.addEventListener('click', () => {
                    document.getElementById('filterRole').value = '';
                    document.getElementById('filterStatus').value = '';
                    document.getElementById('searchInput').value = '';
                    applyUserFilters(); // Refrescar tabla
                });
            }

            // 2. Tarjeta "Usuarios Activos" -> Filtra por Estado: Activo
            const cardActiveUsers = document.getElementById('usersActiveCard');
            if (cardActiveUsers) {
                cardActiveUsers.addEventListener('click', () => {
                    document.getElementById('filterStatus').value = 'active';
                    // Opcional: Limpiar rol para ver todos los activos
                    document.getElementById('filterRole').value = ''; 
                    applyUserFilters();
                });
            }

            // 3. Tarjeta "Técnicos" -> Filtra por Rol: Técnico
            const cardTechUsers = document.getElementById('usersAgentsCard');
            if (cardTechUsers) {
                cardTechUsers.addEventListener('click', () => {
                    document.getElementById('filterRole').value = 'tech';
                    applyUserFilters();
                });
            }

            // 4. Tarjeta "Nuevos Hoy" -> (Como no hay filtro de fecha visible, hacemos reset)
            const cardNewUsers = document.getElementById('usersNewTodayCard');
            if (cardNewUsers) {
                cardNewUsers.addEventListener('click', () => {
                    // Mostramos todos (reset) o podrías implementar lógica compleja aquí
                    document.getElementById('filterRole').value = '';
                    document.getElementById('filterStatus').value = '';
                    document.getElementById('searchInput').value = '';
                    applyUserFilters();
                });
            }

            // === EVENTOS CLIC PARA TARJETAS PRINCIPALES (DASHBOARD) ===

            // 1. Tarjeta "Tickets Totales" -> Lleva a Gestión y muestra TODO
            const cardTotalDash = document.getElementById('cardTotalTickets');
            if (cardTotalDash) {
                cardTotalDash.style.cursor = 'pointer'; // Manito al pasar el mouse
                cardTotalDash.addEventListener('click', () => {
                    showPage('tickets');
                    // Reseteamos todos los filtros
                    document.getElementById('ticketStatusFilter').value = '';
                    document.getElementById('ticketPriorityFilter').value = '';
                    document.getElementById('ticketSearch').value = '';
                    applyTicketFilters();
                });
            }

            // 2. Tarjeta "Pendientes" -> Filtra estado: Pendiente
            const cardPendingDash = document.getElementById('cardPendingTickets');
            if (cardPendingDash) {
                cardPendingDash.style.cursor = 'pointer';
                cardPendingDash.addEventListener('click', () => {
                    showPage('tickets');
                    document.getElementById('ticketStatusFilter').value = 'pending';
                    document.getElementById('ticketPriorityFilter').value = '';
                    applyTicketFilters();
                });
            }

            // 3. Tarjeta "Resueltos" -> Filtra estado: Resuelto
            const cardResolvedDash = document.getElementById('cardResolvedTickets');
            if (cardResolvedDash) {
                cardResolvedDash.style.cursor = 'pointer';
                cardResolvedDash.addEventListener('click', () => {
                    showPage('tickets');
                    // Asegúrate de usar el value correcto ('completed' o 'resuelto')
                    document.getElementById('ticketStatusFilter').value = 'completed'; 
                    document.getElementById('ticketPriorityFilter').value = '';
                    applyTicketFilters();
                });
            }

            // 4. Tarjeta "Tickets Críticos" -> Filtra Prioridad: Alta + Estado: Pendiente
            // (Nota: Asegúrate de que el ID en tu HTML sea 'cardCriticalTickets' o el que estés usando)
            const cardCriticalDash = document.getElementById('cardCriticalTickets'); 
            if (cardCriticalDash) {
                cardCriticalDash.style.cursor = 'pointer';
                cardCriticalDash.addEventListener('click', () => {
                    showPage('tickets');
                    // Filtramos por Alta/Crítica
                    document.getElementById('ticketPriorityFilter').value = 'critical'; // <-- CAMBIO: 'high' por 'critical'
                    // Y que estén pendientes (porque los resueltos no son urgencia)
                    document.getElementById('ticketStatusFilter').value = 'pending';
                    applyTicketFilters();
                });
            }

            // --- TARJETAS DE GESTIÓN DE TICKETS ---
            
            // 1. Tickets Abiertos -> Filtra por Pendiente
            const btnOpen = document.getElementById('ticketsOpenCard');
            if (btnOpen) {
                btnOpen.style.cursor = 'pointer';
                btnOpen.addEventListener('click', () => {
                    // Limpiar otros filtros
                    document.getElementById('ticketSearch').value = '';
                    document.getElementById('ticketPriorityFilter').value = '';
                    // Aplicar filtro Pendiente
                    document.getElementById('ticketStatusFilter').value = 'pending';
                    applyTicketFilters();
                });
            }

            // 2. Tarjeta "Tiempo Promedio" -> REDIRIGE A REPORTES
            const btnTime = document.getElementById('ticketsResponseTimeCard');
            if (btnTime) {
                btnTime.style.cursor = 'pointer';
                btnTime.addEventListener('click', () => {
                    showPage('reportes'); // <--- CAMBIO: Va a Reportes
                    setTimeout(() => generateReport(true), 500);
                });
            }

            // 3. Tarjeta "Tickets Resueltos" -> FILTRA POR 'all_resolved'
            const btnResolved = document.getElementById('ticketsResolvedCard');
            if (btnResolved) { btnResolved.style.cursor = 'pointer'; btnResolved.addEventListener('click', () => { document.getElementById('ticketSearch').value = ''; document.getElementById('ticketPriorityFilter').value = ''; document.getElementById('ticketStatusFilter').value = 'all_resolved'; applyTicketFilters(); }); }

            // 4. Tarjeta "Satisfacción" -> REDIRIGE A REPORTES
            const btnSat = document.getElementById('ticketsSatisfactionCard');
            if (btnSat) {
                btnSat.style.cursor = 'pointer';
                btnSat.addEventListener('click', () => {
                    showPage('reportes'); // <--- CAMBIO: Va a Reportes
                    setTimeout(() => generateReport(true), 500);
                });
            }
            
            // 4. Tarjeta "Tiempo Promedio" -> Lleva a REPORTES
             const cardTime = document.getElementById('ticketsResponseTimeCard');
            if (cardTime) {
                cardTime.style.cursor = 'pointer';
                cardTime.addEventListener('click', () => {
                    showPage('reportes'); // <-- CAMBIO: Ahora va a reportes
                    setTimeout(() => generateReport(true), 500);
                });
            }
        }

        // ===== SISTEMA DE TEMA =====
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeButton();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
            localStorage.setItem('adminTheme', currentTheme);
            
            // Actualizar gráficos si estamos en la página de reportes
            if (document.getElementById('reportes-page').classList.contains('active')) {
                // Pequeño delay para asegurar que el tema se aplique
                setTimeout(() => {
                    initializeReportCharts();
                }, 100);
            }
            
            showNotification(`Tema cambiado a ${currentTheme === 'dark' ? 'oscuro' : 'claro'}`, 'info');
        }

        function updateThemeButton() {
            const button = document.getElementById('themeToggle');
            if (!button) return; // si no hay botón, no hacemos nada
            const icon = button.querySelector('i');
            
            if (currentTheme === 'dark') {
                icon.className = 'fas fa-moon';
            } else {
                icon.className = 'fas fa-sun';
            }
        }

        // ===== SISTEMA DE NAVEGACIÓN =====
        
        function showPage(page) {
            // Ocultar todas las páginas
            document.querySelectorAll('.page-content').forEach(p => {
                p.classList.remove('active');
            });
            
            // Mostrar la página seleccionada
            document.getElementById(`${page}-page`).classList.add('active');
            
            // Actualizar título
            updatePageTitle(page);
            
            // Actualizar menú activo
            updateActiveMenu(page);
            
            // Cargar datos específicos de la página
            loadPageData(page);
        }

        function updatePageTitle(page) {
            const titles = {
                'dashboard': 'Dashboard del Sistema',
                'tickets': 'Gestión de Tickets',
                'usuarios': 'Gestión de Usuarios',
                'reportes': 'Reportes del Sistema',
                'configuracion': 'Configuración del Sistema',
                
                'areas': 'Gestión de Áreas',
                // --- AGREGA ESTAS 3 LÍNEAS ---
                'categorias': 'Gestión de Categorías',
                'leaderboard': 'Ranking de Técnicos',
                'faq': 'Preguntas Frecuentes (FAQ)'
                // -----------------------------
            };
            
            // Esto se asegura de que si no encuentra el título, no muestre vacío
            const title = titles[page] || 'Sistema de Tickets';
            document.getElementById('pageTitle').textContent = title;
        }

        function updateActiveMenu(page) {
            document.querySelectorAll('.nav-links li').forEach(li => {
                li.classList.remove('active');
            });
            const activeLink = document.querySelector(`.nav-links a[onclick="showPage('${page}')"]`);
            if (activeLink) {
                activeLink.parentElement.classList.add('active');
            }
        }

        function loadPageData(page) {
            switch(page) {
                case 'dashboard':
                    // --- CORRECCIÓN: RESETEAR DATOS AL VOLVER ---
                    // Restauramos la lista completa para que no se quede con filtros viejos
                    currentTickets = [...masterTickets]; 
                    
                    updateDashboardStats();
                    updateRecentTickets();
                    break;
                case 'tickets':
                    // Al entrar a tickets, aplicamos los filtros que estén en los inputs
                    applyTicketFilters(); 
                    break;
                case 'usuarios':
                    loadUsersData();
                    break;
                case 'areas':
                    loadAreasData();
                    break;
                case 'categorias':   // <--- NUEVO CASO
                    loadCategoriesData();
                    break;
                case 'leaderboard':
                    calculateLeaderboard();
                    break;
                case 'faq':
                    loadFaqData();
                    break;
                case 'reportes':
                    populateReportFilters();
                    // Solo generamos el reporte (que llena las barras)
                    setTimeout(() => {
                        generateReport(true); 
                    }, 200);
                    break;
                case 'configuracion':
                    loadSettings();
                    break;
            }
        }

        function loadCategoriesData() {
            const tbody = document.getElementById('categoriasBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const totalCategorias = masterCategories ? masterCategories.length : 0;
            const totalPages = Math.ceil(totalCategorias / ITEMS_PER_PAGE);
            if (totalPages > 0 && currentPage.categorias > totalPages) {
                currentPage.categorias = totalPages;
            } else if (totalCategorias === 0) {
                currentPage.categorias = 1;
            }

            // Usamos masterCategories (que viene de la BD)
            if (!masterCategories || masterCategories.length === 0) {
                renderPaginationControls(totalCategorias, currentPage.categorias, 'categoriasPagination', 'categorias');
                return;
            }

            const pageData = paginateData(masterCategories, currentPage.categorias);

            pageData.forEach(cat => {
                const row = document.createElement('tr');
                const estadoClass = cat.activo ? 'active' : 'inactive';
                const estadoText = cat.activo ? 'Activa' : 'Inactiva';
                
                row.innerHTML = `
                    <td><strong>${cat.id}</strong></td>
                    <td>${cat.nombre}</td>
                    <td>${cat.descripcion}</td>
                    <td style="text-align: center;"><span class="badge bg-secondary">${cat.cantidad_tickets}</span></td>
                    <td><span class="status ${estadoClass}">${estadoText}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn edit" onclick="editCategory(${cat.id})" title="Editar categoría">
                            <i class="fas fa-edit"></i> EDITAR
                        </button>
                        <button class="action-btn delete" onclick="if(!confirm('¿Estás seguro de que quieres eliminar esta categoría? Esta acción no se puede deshacer.')) return false; window.location.href='/categoria/eliminar/${cat.id}/';" title="Eliminar categoría">
                            <i class="fas fa-trash"></i> BORRAR
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            renderPaginationControls(masterCategories.length, currentPage.categorias, 'categoriasPagination', 'categorias');
        }

        function toggleMobileMenu() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        
        function saveUsersToStorage() {
            try {
                localStorage.setItem('adminUsers', JSON.stringify(masterUsers));
            } catch (e) {
                console.error('Error guardando usuarios en localStorage', e);
            }
        }

        function saveTicketsToStorage() {
            try {
                localStorage.setItem('ticketsApp', JSON.stringify(masterTickets));
            } catch (e) {
                console.error('Error guardando tickets en localStorage', e);
            }
        }

// ===== SISTEMA DE USUARIOS =====
        
        function loadUsersData() {
            // Ya no leemos de localStorage ni mocks, usamos los datos de Django (masterUsers)
            currentUsers = [...masterUsers];
            displayUsers(currentUsers);
            updateUserStats(currentUsers);
        }

        function displayUsers(users) {
            const usersBody = document.getElementById('usersBody');
            const emptyState = document.getElementById('emptyState');
            
            if (!usersBody) return;
            
            usersBody.innerHTML = '';

            const totalUsers = users.length;
            const totalPages = Math.ceil(totalUsers / ITEMS_PER_PAGE);
            if (totalPages > 0 && currentPage.users > totalPages) {
                currentPage.users = totalPages;
            } else if (totalUsers === 0) {
                currentPage.users = 1;
            }

            if (totalUsers === 0) {
                document.querySelector('#usersTable table').style.display = 'none';
                emptyState.style.display = 'block';
                renderPaginationControls(users.length, currentPage.users, 'usersPagination', 'users');
                return;
            }

            document.querySelector('#usersTable table').style.display = 'table';
            emptyState.style.display = 'none';

            const pageData = paginateData(users, currentPage.users);

            pageData.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>U-${user.id.toString().padStart(4, '0')}</strong></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="avatar" style="width: 35px; height: 35px; font-size: 0.9rem;">
                                ${user.nombre.split(' ').map(n => n[0]).join('')}
                            </div>
                            <strong>${user.username}</strong>
                        </div>
                    </td>
                    <td>${user.nombre}</td>
                    <td>${user.email}</td>
                    <td>
                        <span class="role ${user.rol}">
                            ${user.rol.charAt(0).toUpperCase() + user.rol.slice(1)}
                        </span>
                    </td>
                    <td>
                        <span class="status ${user.estado}">
                            ${user.estado.charAt(0).toUpperCase() + user.estado.slice(1)}
                        </span>
                    </td>
                    <td>${formatDate(user.fecha_registro)}</td>
                    <td>${formatDate(user.ultimo_acceso)}</td>
                    <td class="action-buttons">
                        <button class="action-btn edit" onclick="editUser(${user.id})" title="Modificar usuario">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn reset" onclick="resetPassword(${user.id})" title="Restablecer contraseña">
                            <i class="fas fa-key"></i> Reset Pass
                        </button>
                        <button class="action-btn delete" onclick="deleteUser(${user.id})" title="Eliminar usuario permanentemente">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </td>
                `;
                usersBody.appendChild(row);
            });

            renderPaginationControls(users.length, currentPage.users, 'usersPagination', 'users');
        }

        function updateUserStats(users) {
            // Cálculos (estos no dan error)
            const total = users.length;
            const activos = users.filter(u => u.estado === 'active').length;
            const soporte = users.filter(u => u.rol === 'tech').length; 
            const nuevosHoy = users.filter(u => {
                const today = new Date().toDateString();
                const userDate = new Date(u.fecha_registro).toDateString();
                return userDate === today;
            }).length;

            // --- AQUÍ ESTABA EL ERROR ---
            // Antes intentaba escribir directo. Ahora preguntamos "if exists"
            
            if (document.getElementById('totalUsuarios')) {
                document.getElementById('totalUsuarios').textContent = total;
            }
            if (document.getElementById('activosUsuarios')) {
                document.getElementById('activosUsuarios').textContent = activos;
            }
            if (document.getElementById('soporteUsuarios')) {
                document.getElementById('soporteUsuarios').textContent = soporte;
            }
            if (document.getElementById('nuevosHoyUsuarios')) {
                document.getElementById('nuevosHoyUsuarios').textContent = nuevosHoy;
            }
        }

        function applyUserFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const statusFilter = document.getElementById('filterStatus').value;

            const filteredUsers = masterUsers.filter(user => {
                const matchesSearch = user.username.toLowerCase().includes(searchTerm) ||
                                     (user.nombre && user.nombre.toLowerCase().includes(searchTerm)) ||
                                     user.email.toLowerCase().includes(searchTerm);
                                     
                const matchesRole = !roleFilter || user.rol === roleFilter;
                const matchesStatus = !statusFilter || user.estado === statusFilter;

                return matchesSearch && matchesRole && matchesStatus;
            });

            currentUsers = filteredUsers;
            displayUsers(currentUsers);
            updateUserStats(currentUsers);
        }

        function refreshUsers() {
            showNotification('Actualizando usuarios...', 'info');
            setTimeout(() => {
                // Recargar desde localStorage y volver a aplicar filtros
                const stored = localStorage.getItem('adminUsers');
                if (stored) {
                    try {
                        masterUsers = JSON.parse(stored);
                    } catch (e) {
                        console.error('Error leyendo usuarios desde localStorage al refrescar', e);
                    }
                }
                applyUserFilters();
                showNotification('Usuarios actualizados correctamente', 'success');
            }, 500);
        }

        function exportUsers() {
            showNotification('Generando archivo de exportación...', 'info');
            setTimeout(() => {
                showNotification('Archivo de usuarios exportado correctamente', 'success');
                // En una aplicación real, aquí descargarías el archivo
                downloadCSV(currentUsers, 'usuarios.csv');
            }, 1500);
        }

        // Funciones globales para los botones de acción
        window.editUser = function(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (user) {
                openUserModal(user);
            }
        };

        window.resetPassword = function(userId) {
            if (confirm(`¿Resetear contraseña del usuario U-${userId.toString().padStart(4, '0')}?`)) {
                showNotification(`Contraseña reseteada para U-${userId.toString().padStart(4, '0')}`, 'success');
            }
        };

        window.deleteUser = function(userId) {
            if (confirm(`¿Eliminar usuario U-${userId.toString().padStart(4, '0')}? Esta acción no se puede deshacer.`)) {
                // Eliminar el usuario de la lista maestra
                masterUsers = masterUsers.filter(u => u.id === undefined ? true : u.id !== userId);
                // Guardar cambios y volver a aplicar filtros
                saveUsersToStorage();
                applyUserFilters();
                showNotification(`Usuario U-${userId.toString().padStart(4, '0')} eliminado`, 'success');
            }
        };

        // ===== SISTEMA DE TICKETS =====
        
        function loadTicketsData() {
             // Ya no leemos de localStorage ni mocks, usamos los datos de Django (masterTickets)
            currentTickets = [...masterTickets];
            updateTicketsTable();
            updateRecentTickets();
            updateDashboardStats(); // Importante actualizar contadores
        }

        function updateTicketsTable() {
            const tbody = document.getElementById('ticketsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const totalTickets = currentTickets.length;
            const totalPages = Math.ceil(totalTickets / ITEMS_PER_PAGE);
            if (totalPages > 0 && currentPage.tickets > totalPages) {
                currentPage.tickets = totalPages;
            } else if (totalTickets === 0) {
                currentPage.tickets = 1;
            }

            const pageData = paginateData(currentTickets, currentPage.tickets);

            pageData.forEach(ticket => {
                const row = document.createElement('tr');

                // --- LÓGICA SLA (Contador restante) ---
                let slaIcon = '';
                let slaTexto = '';
                
                // Calculamos tiempo restante real
                const horasRestantes = ticket.horas_limite - ticket.horas;
                
                const infoSLA = `Prioridad: ${getPriorityText(ticket.prioridad)}\nLímite: ${ticket.horas_limite}h`;

                if (ticket.sla === 'overdue') {
                    slaIcon = `<i class="fas fa-fire" style="color: #ef4444;" title="VENCIDO hace ${Math.abs(horasRestantes).toFixed(1)}h"></i>`;
                    slaTexto = `<span style="color: #ef4444; font-weight:bold;">+${Math.abs(horasRestantes).toFixed(1)}h</span>`;
                } else if (ticket.sla === 'warning') {
                    slaIcon = `<i class="fas fa-exclamation-triangle" style="color: #f59e0b;" title="Por vencer"></i>`;
                    slaTexto = `<span style="color: #f59e0b; font-weight:bold;">Quedan ${horasRestantes.toFixed(1)}h</span>`;
                } else {
                    slaIcon = `<i class="fas fa-check-circle" style="color: #10b981;" title="A tiempo"></i>`;
                    slaTexto = `<span style="color: #10b981;">Quedan ${horasRestantes.toFixed(1)}h</span>`;
                }
                // -----------------------------------------------

                row.innerHTML = `
                    <td><strong>T-${ticket.id.toString().padStart(6, '0')}</strong></td>
                    <td>${ticket.titulo}</td>
                    <td>${ticket.area || '-'}</td>
                    <td>${ticket.usuario}</td>
                    <td>
                        <span class="priority ${ticket.prioridad}" 
                              onclick="cycleTicketPriority(${ticket.id})" 
                              style="cursor: pointer; user-select: none;" 
                              title="Clic para cambiar prioridad">
                            ${getPriorityText(ticket.prioridad)}
                        </span>
                    </td>
                    <td style="display: flex; align-items: center; gap: 10px;">
                        <span class="status ${normalizeStatus(ticket.estado)}">
                            ${getStatusText(ticket.estado)}
                        </span>
                        
                        <div style="font-size: 1.2rem;">
                            ${slaIcon}
                        </div>
                        
                        <div style="margin-left: 5px;">
                            ${slaTexto}
                        </div>
                    </td>
                    <td>${formatDate(ticket.fecha)}</td>
                    <td>${ticket.agente || '-'}</td>
                    <td class="action-buttons">
                        <button class="action-btn edit" onclick="editTicket(${ticket.id})" title="Editar ticket">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            renderPaginationControls(currentTickets.length, currentPage.tickets, 'ticketsPagination', 'tickets');
        }

        function updateRecentTickets() {
            const tbody = document.getElementById('recentTicketsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Tomamos los 5 más recientes
            const recentTickets = currentTickets.slice(0, 5);
            
            recentTickets.forEach(ticket => {
                const row = document.createElement('tr');

                // --- LÓGICA SLA (Copiada para que funcione aquí también) ---
                let slaIcon = '';
                let slaTexto = '';
                
                // Calculamos tiempo restante
                const horasRestantes = ticket.horas_limite - ticket.horas;
                const infoSLA = `Prioridad: ${getPriorityText(ticket.prioridad)}\nLímite: ${ticket.horas_limite}h`;

                if (ticket.sla === 'overdue') {
                    slaIcon = `<i class="fas fa-fire" style="color: #ef4444;" title="VENCIDO hace ${Math.abs(horasRestantes).toFixed(1)}h"></i>`;
                    slaTexto = `<span style="color: #ef4444; font-weight:bold;">+${Math.abs(horasRestantes).toFixed(1)}h</span>`;
                } else if (ticket.sla === 'warning') {
                    slaIcon = `<i class="fas fa-exclamation-triangle" style="color: #f59e0b;" title="Por vencer"></i>`;
                    slaTexto = `<span style="color: #f59e0b; font-weight:bold;">Quedan ${horasRestantes.toFixed(1)}h</span>`;
                } else {
                    slaIcon = `<i class="fas fa-check-circle" style="color: #10b981;" title="A tiempo"></i>`;
                    slaTexto = `<span style="color: #10b981;">Quedan ${horasRestantes.toFixed(1)}h</span>`;
                }
                // ------------------------------------------------------------

                row.innerHTML = `
                    <td><strong>T-${ticket.id.toString().padStart(6, '0')}</strong></td>
                    <td>${ticket.titulo}</td>
                    <td>${ticket.area || '-'}</td>
                    <td>${ticket.usuario}</td>
                    <td><span class="priority ${ticket.prioridad}" style="cursor: default;">${getPriorityText(ticket.prioridad)}</span></td>
                    
                    <td style="display: flex; align-items: center; gap: 10px;">
                        <span class="status ${normalizeStatus(ticket.estado)}">${getStatusText(ticket.estado)}</span>
                        <div style="font-size: 1.2rem;">
                            ${slaIcon}
                        </div>
                        <div style="margin-left: 5px; font-size: 0.85rem;">
                            ${slaTexto}
                        </div>
                    </td>
                    
                    <td>${formatDate(ticket.fecha)}</td>
                    <td>${ticket.agente || '-'}</td>
                    <td class="action-buttons">
                        <button class="action-btn edit" onclick="editTicket(${ticket.id})" title="Editar ticket">
                            <i class="fas fa-edit"></i> EDITAR
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function applyTicketFilters() {
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
            const statusFilter = document.getElementById('ticketStatusFilter').value;
            const priorityFilter = document.getElementById('ticketPriorityFilter').value;
            const areaFilter = document.getElementById('ticketAreaFilter').value;
            
            const filteredTickets = masterTickets.filter(ticket => {
                const matchesSearch = ticket.titulo.toLowerCase().includes(searchTerm) || 
                                     ticket.usuario.toLowerCase().includes(searchTerm) ||
                                     `T-${ticket.id.toString().padStart(6, '0')}`.includes(searchTerm);
                                     
                // --- LÓGICA DE ESTADO MEJORADA ---
                let matchesStatus = true;
                const s = normalizeStatus(ticket.estado);

                if (statusFilter === 'all_resolved') {
                    // Si el filtro es "all_resolved", aceptamos 'completed' O 'closed'
                    matchesStatus = (s === 'completed' || s === 'closed');
                } else {
                    // Comportamiento normal para el resto
                    matchesStatus = !statusFilter || s === statusFilter;
                }
                // ---------------------------------

                const matchesPriority = !priorityFilter || normalizePriority(ticket.prioridad) === priorityFilter;
                
                const ticketAreaName = ticket.area || "Sin Categoría";
                const matchesArea = !areaFilter || ticketAreaName === areaFilter;
                
                return matchesSearch && matchesStatus && matchesPriority && matchesArea;
            });
            
            currentTickets = filteredTickets;
            updateTicketsTable();
        }

        function normalizePriority(priority) {
            if (!priority) return 'medium';
            switch (priority.toLowerCase()) {
                case 'alta': case 'high': return 'high';
                case 'media': case 'medium': return 'medium';
                case 'baja': case 'low': return 'low';
                // Agregamos estos casos:
                case 'critica': case 'crítica': case 'critical': return 'critical';
                default: return 'medium';
            }
        }

        function getPriorityText(priority) {
            const normalized = normalizePriority(priority);
            const texts = {
                'high': 'Alta',
                'medium': 'Media',
                'low': 'Baja',
                'critical': 'Crítica' // <--- AQUÍ ESTÁ LA TRADUCCIÓN
            };
            return texts[normalized] || 'Media';
        }

        function normalizeStatus(status) {
            if (!status) return 'pending';
            const s = status.toLowerCase();

            // Mapeo seguro para que el CSS lo reconozca
            if (['new', 'nuevo', 'pending', 'pendiente'].includes(s)) return 'pending'; // Amarillo
            if (['in-progress', 'en_progreso', 'en progreso'].includes(s)) return 'in-progress'; // Azul
            if (['resolved', 'resuelto', 'completed', 'completo'].includes(s)) return 'completed'; // Verde
            if (['closed', 'cerrado'].includes(s)) return 'closed'; // Gris

            return 'pending';
        }

        function getStatusText(status) {
            if(!status) return 'Pendiente';
            const s = status.toLowerCase();
            
            if (s === 'new' || s === 'nuevo' || s === 'pending') return 'NUEVO';
            if (s === 'in-progress' || s === 'en_progreso') return 'EN PROGRESO';
            if (s === 'resolved' || s === 'resuelto' || s === 'completed') return 'RESUELTO';
            if (s === 'closed' || s === 'cerrado') return 'CERRADO';
            
            return status.toUpperCase();
        }

        function cycleTicketPriority(id) {
            // Redirige a la vista que acabamos de crear
            window.location.href = `/ticket/${id}/cambiar-prioridad/`;
        }


window.viewTicket = function(ticketId) {
            const ticket = masterTickets.find(t => t.id === ticketId);
            if (ticket) {
                alert(`Vista de Ticket T-${ticketId.toString().padStart(6, '0')}\n\nTítulo: ${ticket.titulo}\nDescripción: ${ticket.descripcion}\nEstado: ${getStatusText(ticket.estado)}\nPrioridad: ${getPriorityText(ticket.prioridad)}`);
            }
        };

        window.editTicket = function(ticketId) {
            const ticket = masterTickets.find(t => t.id === ticketId);
            if (ticket) {
                // Abrir el modal en modo edición
                openTicketModal(ticket);
            } else {
                console.error("Ticket no encontrado:", ticketId);
            }
        };

        // ===== SISTEMA DE MODALES =====
        
        
        function openUserModal(user = null) {
        const modal = document.getElementById('userModal');
        const title = document.getElementById('userModalTitle');
        const form = document.getElementById('userForm');
        
        // Elementos del formulario
        const userIdInput = document.getElementById('userId');
        const usernameInput = document.getElementById('username');
        const fullNameInput = document.getElementById('fullName');
        const emailInput = document.getElementById('email');
        const roleInput = document.getElementById('userRole');
        const passwordInput = document.getElementById('password');
        const passHelp = document.getElementById('passHelp');
        
        if (user) {
            // MODO EDICIÓN
            title.textContent = 'Editar Usuario';
            userIdInput.value = user.id;
            usernameInput.value = user.username;
            fullNameInput.value = user.nombre;
            emailInput.value = user.email;
            
            // Seleccionar el rol correcto
            // (Asegúrate de que user.rol traiga 'admin', 'tech' o 'user')
            roleInput.value = user.rol; 
            
            // La contraseña no se muestra, es opcional en edición
            passwordInput.value = '';
            passwordInput.removeAttribute('required');
            passHelp.style.display = 'block';
            
        } else {
            // MODO CREACIÓN
            title.textContent = 'Crear Nuevo Usuario';
            form.reset();
            userIdInput.value = ''; // ID vacío indica crear
            
            // Contraseña obligatoria al crear
            passwordInput.setAttribute('required', 'required');
            passHelp.style.display = 'none';
        }
        
        modal.classList.add('active');
    }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        function openTicketModal(ticket = null) {
            const modal = document.getElementById('ticketModal');
            const assignedUserSelect = document.getElementById('assignedUser');
            const form = document.getElementById('ticketForm');
            const titleEl = document.getElementById('ticketModalTitle');
            const statusSelect = document.getElementById('ticketStatusField');
            
            if (!modal || !assignedUserSelect || !form) return;
            
            // Reiniciar formulario
            form.reset();
            
            // Limpiar y cargar opciones de usuarios
            assignedUserSelect.innerHTML = '<option value="">Sin asignar</option>';
            
            // FILTRO DE TÉCNICOS: Solo mostramos usuarios activos que sean 'tech' o 'admin'
            currentUsers.filter(user => user.estado === 'active').forEach(user => {
                
                // AQUÍ ESTÁ EL FILTRO CLAVE:
                if (user.rol === 'tech' || user.rol === 'admin') {
                    
                    const option = document.createElement('option');
                    option.value = user.username;
                    
                    // DE PASO ARREGLAMOS EL PUNTO 4 (Nombres duplicados)
                    // Si el nombre es igual al username, solo mostramos uno
                    if (user.nombre && user.nombre !== user.username) {
                        option.textContent = `${user.nombre} (${user.username})`;
                    } else {
                        option.textContent = user.username; 
                    }
                    
                    assignedUserSelect.appendChild(option);
                }
            });
            
            if (ticket) {
                // Modo edición
                if (titleEl) titleEl.textContent = 'Editar Ticket';
                document.getElementById('ticketTitle').value = ticket.titulo || '';
                document.getElementById('ticketDescription').value = ticket.descripcion || '';
                document.getElementById('modalTicketArea').textContent = ticket.area || 'No especificada';
                document.getElementById('ticketPriority').value = ticket.prioridad || 'low';
                if (statusSelect) statusSelect.value = ticket.estado || 'pending';
                if (ticket.agente) {
                    assignedUserSelect.value = ticket.agente;
                }
                form.dataset.ticketId = ticket.id;
            } else {
                // Modo creación
                const historyBody = document.getElementById('ticketHistoryBody');
                if (historyBody) {
                    historyBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 10px; color:#94a3b8;">Sin movimientos registrados</td></tr>';
                }
                if (titleEl) titleEl.textContent = 'Crear Nuevo Ticket';
                if (statusSelect) statusSelect.value = 'pending';
                delete form.dataset.ticketId;
            }
            
            modal.classList.add('active');
        }

        function closeTicketModal() {
            document.getElementById('ticketModal').classList.remove('active');
        }


function handleTicketSubmit(e) {
            e.preventDefault();

            const form = e.target;
            const ticketId = form.dataset.ticketId;

            const titulo = document.getElementById('ticketTitle').value;
            const descripcion = document.getElementById('ticketDescription').value;
            const prioridad = document.getElementById('ticketPriority').value;
            const agente = document.getElementById('assignedUser').value || "";
            const statusField = document.getElementById('ticketStatusField');
            const estado = statusField ? statusField.value : 'pending';

            if (ticketId) {
                // Editar ticket existente en la lista maestra
                const idNum = parseInt(ticketId, 10);
                const index = masterTickets.findIndex(t => t.id === idNum);
                if (index !== -1) {
                    masterTickets[index] = {
                        ...masterTickets[index],
                        titulo,
                        descripcion,
                        prioridad,
                        agente,
                        estado
                    };
                }
                showNotification('Ticket actualizado correctamente', 'success');
            } else {
                // Crear nuevo ticket
                const nextId = masterTickets.length > 0
                    ? Math.max(...masterTickets.map(t => t.id || 0)) + 1
                    : 1;

                const ticketData = {
                    id: nextId,
                    titulo,
                    descripcion,
                    prioridad,
                    usuario: "admin", // Por defecto el usuario actual
                    estado,
                    fecha: new Date().toISOString().split('T')[0],
                    agente
                };

                masterTickets.unshift(ticketData);
                showNotification('Ticket creado correctamente', 'success');
            }

            // Guardar cambios y refrescar tablas
            saveTicketsToStorage();
            applyTicketFilters();
            updateRecentTickets();
            updateDashboardStats();
            closeTicketModal();
        }


        // ===== SISTEMA DE GRÁFICOS  =====

        // ===== FUNCIÓN PARA REDIMENSIONAR GRÁFICOS AL CAMBIAR TAMAÑO DE VENTANA =====
        function handleResize() {
            if (document.getElementById('reportes-page').classList.contains('active')) {
                // Re-inicializar gráficos cuando la ventana cambia de tamaño
                setTimeout(() => {
                }, 250);
            }
        }

        // Agregar event listener para resize
        window.addEventListener('resize', handleResize);

        // ===== SISTEMA DE REPORTES =====
        
    function populateReportFilters() {
        // 1. Llenar Categorías
        const catSelect = document.getElementById('reportCategoryFilter');
        if (catSelect && masterCategories) {
            catSelect.innerHTML = '<option value="">Todas las Categorías</option>';
            masterCategories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.nombre; // Filtramos por nombre
                opt.textContent = c.nombre;
                catSelect.appendChild(opt);
            });
        }

        // 2. Llenar Técnicos (Usuarios con rol 'tech')
        const techSelect = document.getElementById('reportTechFilter');
        if (techSelect && masterUsers) {
            techSelect.innerHTML = '<option value="">Todos los Técnicos</option>';
            masterUsers.filter(u => u.rol === 'tech').forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.username; // Filtramos por username
                opt.textContent = t.nombre || t.username;
                techSelect.appendChild(opt);
            });
        }
    }
        
    // Aceptamos un parámetro 'silent' (por defecto es false)
        function generateReport(silent = false) {
        const reportTypeInput = document.getElementById('reportType');
        const reportType = reportTypeInput ? reportTypeInput.value : 'tickets';

        // 1. OBTENER VALORES DE LOS FILTROS
        const fStart = document.getElementById('startDate') ? document.getElementById('startDate').value : '';
        const fEnd = document.getElementById('endDate') ? document.getElementById('endDate').value : '';
        const fCat = document.getElementById('reportCategoryFilter') ? document.getElementById('reportCategoryFilter').value : '';
        const fPrio = document.getElementById('reportPriorityFilter') ? document.getElementById('reportPriorityFilter').value : '';
        const fTech = document.getElementById('reportTechFilter') ? document.getElementById('reportTechFilter').value : '';

        if (!silent) {
            showNotification(`Generando reporte filtrado...`, 'info');
        }

        setTimeout(() => {
            const tbody = document.getElementById('reportTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // 2. APLICAR FILTROS A LOS DATOS
            const sourceTickets = (masterTickets && masterTickets.length ? masterTickets : currentTickets) || [];
            const filteredData = sourceTickets.filter(t => {
                let pass = true;
                
                // Filtro Fecha (Si hay fechas seleccionadas)
                if (fStart || fEnd) {
                    const tDate = new Date(t.fecha);
                    if (fStart && new Date(fStart) > tDate) pass = false;
                    if (fEnd && new Date(fEnd) < tDate) pass = false;
                }

                // Filtro Categor?a
                if (fCat && (t.categoria || "Sin Categor?a") !== fCat) pass = false;
                
                // Filtro Prioridad
                if (fPrio && normalizePriority(t.prioridad) !== fPrio) pass = false;
                
                // Filtro T?cnico
                if (fTech && (t.agente || "") !== fTech) pass = false;

                return pass;
            });

            // Guardamos los datos filtrados para exportarlos
            currentReportTickets = filteredData;

            // 3. USAR 'filteredData' PARA LOS C?LCULOS (En vez de masterTickets)
            const categoriasUnicas = [...new Set(filteredData.map(t => t.categoria || "Sin Categor?a"))];
            let totalGlobal = 0;
            let resueltosGlobal = 0;

            categoriasUnicas.forEach(catName => {
                const ticketsDeCategoria = filteredData.filter(t => (t.categoria || "Sin Categor?a") === catName);
                const total = ticketsDeCategoria.length;
                const resueltos = ticketsDeCategoria.filter(t => t.estado === 'resolved' || t.estado === 'completed' || t.estado === 'closed' || t.estado === 'cerrado' || t.estado === 'resuelto').length;
                
                // C?lculo de tiempo promedio
                let sumaHoras = 0;
                let countConTiempo = 0;
                ticketsDeCategoria.forEach(t => {
                    if (t.horas && parseFloat(t.horas) > 0) {
                        sumaHoras += parseFloat(t.horas);
                        countConTiempo++;
                    }
                });
                const tiempo = countConTiempo > 0 ? (sumaHoras / countConTiempo).toFixed(1) + 'h' : '-';

                // C?lculo de satisfacci?n
                let sumaEstrellas = 0;
                let countVotos = 0;
                ticketsDeCategoria.forEach(t => {
                    if (t.calificacion && parseInt(t.calificacion) > 0) {
                        sumaEstrellas += parseInt(t.calificacion);
                        countVotos++;
                    }
                });
                
                let satisfaccion = 0;
                if (countVotos > 0) {
                    satisfaccion = Math.round((sumaEstrellas / countVotos / 5) * 100);
                }

                // Barras de color
                let colorBarra = '#10b981';
                if (satisfaccion > 0 && satisfaccion < 60) colorBarra = '#ef4444';
                
                // Acumuladores globales
                totalGlobal += total;
                resueltosGlobal += resueltos;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold;">${catName}</td>
                    <td style="text-align:center;">${total}</td>
                    <td style="text-align:center;">${resueltos}</td>
                    <td style="text-align:center;">${tiempo}</td>
                    <td style="text-align:center;">
                        <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                            <div style="width:50px; height:6px; background:#e2e8f0; border-radius:3px;">
                                <div style="width:${satisfaccion}%; height:100%; background:${colorBarra}; border-radius:3px;"></div>
                            </div>
                            <span style="font-size: 0.85rem;">${satisfaccion}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Fila de TOTALES
            const trTotal = document.createElement('tr');
            trTotal.style.backgroundColor = 'rgba(16, 185, 129, 0.1)'; // Un verde muy suave para destacar
            trTotal.style.borderTop = '2px solid var(--primary)';
            trTotal.innerHTML = `
                <td style="font-weight:900; text-align:right;">TOTAL GLOBAL:</td>
                <td style="font-weight:900; text-align:center;">${totalGlobal}</td>
                <td style="font-weight:900; text-align:center;">${resueltosGlobal}</td>
                <td></td>
                <td></td>
            `;
            tbody.appendChild(trTotal);
            
            // ACTUALIZAR T?TULO Y GR?FICOS
            document.getElementById('reportTableTitle').textContent = `Reporte de ${getReportTypeText(reportType)}`;
            
            updateChartsData(reportType, filteredData); 
            
            if (!silent) {
                showNotification('Reporte generado correctamente', 'success');
            }
        }, 300);
    }

        function getReportTypeText(type) {
            const texts = {
                'tickets': 'Tickets',
                'users': 'Usuarios',
                'performance': 'Rendimiento'
            };
            return texts[type] || type;
        }

        function exportToExcel() {
            const source = (currentReportTickets && currentReportTickets.length > 0) ? currentReportTickets : masterTickets;

            if (!source || source.length === 0) {
                showNotification("No hay datos para exportar", "error");
                return;
            }

            const data = source.map(t => ({
                ID: t.id || '',
                Categoria: t.categoria || 'Sin Categoría',
                Prioridad: normalizePriority(t.prioridad),
                Estado: t.estado || '',
                Agente: t.agente || '',
                Fecha: t.fecha || '',
                Horas: t.horas || ''
            }));

            downloadCSV(data, 'reporte_tickets.csv');
            showNotification('Exportado a Excel (CSV)', 'success');
        }

    function exportToPDF() {
        // 1. Leer los valores actuales de los filtros
        const inicio = document.getElementById('startDate').value;
        const fin = document.getElementById('endDate').value;
        const categoria = document.getElementById('reportCategoryFilter').value;
        const prioridad = document.getElementById('reportPriorityFilter').value;
        const tecnico = document.getElementById('reportTechFilter').value;

        // 2. Construir la URL con parámetros (Query String)
        const params = new URLSearchParams();
        
        if (inicio) params.append('inicio', inicio);
        if (fin) params.append('fin', fin);
        
        // Solo agregamos si no es el valor por defecto
        if (categoria && categoria !== "Todas las Categorías") params.append('categoria', categoria);
        if (prioridad && prioridad !== "Todas las Prioridades") params.append('prioridad', prioridad);
        if (tecnico && tecnico !== "Todos los Técnicos") params.append('tecnico', tecnico);

        // 3. Redirigir a la URL de Django con los filtros pegados
        // Asegúrate de que la ruta base coincida con tu urls.py (/reportes/exportar/pdf/)
        const urlFinal = `/reportes/exportar/pdf/?${params.toString()}`;
        
        showNotification("Generando PDF filtrado...", "info");
        
        // Navegar a la URL para iniciar la descarga
        window.location.href = urlFinal;
    }

        function updateChartsData(reportType, data = null) {
            // Actualizar datos de gráficos según el tipo de reporte
            // Usar datos filtrados o todos
            const source = (data && data.length) ? data : (masterTickets && masterTickets.length ? masterTickets : currentTickets);
            const total = source.length || 1; // Evitar división por cero

            // --- 1. ACTUALIZAR BARRAS DE ESTADO ---
            const p = source.filter(t => normalizeStatus(t.estado) === 'pending').length;
            const i = source.filter(t => normalizeStatus(t.estado) === 'in-progress').length;
            const r = source.filter(t => normalizeStatus(t.estado) === 'completed' || normalizeStatus(t.estado) === 'closed').length;

            document.getElementById('barCountPending').textContent = p;
            document.getElementById('barWidthPending').style.width = Math.round((p / total) * 100) + '%';

            document.getElementById('barCountProgress').textContent = i;
            document.getElementById('barWidthProgress').style.width = Math.round((i / total) * 100) + '%';

            document.getElementById('barCountResolved').textContent = r;
            document.getElementById('barWidthResolved').style.width = Math.round((r / total) * 100) + '%';


            // --- 2. ACTUALIZAR BARRAS DE PRIORIDAD ---
            const h = source.filter(t => normalizePriority(t.prioridad) === 'high' || normalizePriority(t.prioridad) === 'critical').length;
            const m = source.filter(t => normalizePriority(t.prioridad) === 'medium').length;
            const l = source.filter(t => normalizePriority(t.prioridad) === 'low').length;

            document.getElementById('barCountHigh').textContent = h;
            document.getElementById('barWidthHigh').style.width = Math.round((h / total) * 100) + '%';

            document.getElementById('barCountMedium').textContent = m;
            document.getElementById('barWidthMedium').style.width = Math.round((m / total) * 100) + '%';

            document.getElementById('barCountLow').textContent = l;
            document.getElementById('barWidthLow').style.width = Math.round((l / total) * 100) + '%';
        }

        // ===== SISTEMA DE CONFIGURACIÓN =====
        
        function loadSettings() {
            // La vista de configuración es solo informativa ahora,
            // por lo que esta función no necesita ejecutar ninguna acción.
            console.log("Cargando página de configuración (informativa).");
        }

        function saveSettings() {
            const settings = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                autoAssignTickets: document.getElementById('autoAssignTickets').checked,
                autoReminders: document.getElementById('autoReminders').checked,
                sessionDuration: parseInt(document.getElementById('sessionDuration').value),
                loginAttempts: parseInt(document.getElementById('loginAttempts').value),
                passwordExpiry: parseInt(document.getElementById('passwordExpiry').value),
                // Forzamos tema claro sin permitir cambio
                colorTheme: 'light',
                language: document.getElementById('language').value
            };
            
            localStorage.setItem('adminSettings', JSON.stringify(settings));
            
            // Aseguramos que siempre se aplique modo claro
            if (currentTheme !== 'light') {
                currentTheme = 'light';
                applyTheme(currentTheme);
            }
            
            showNotification('Configuración guardada correctamente', 'success');
        }

        // ===== SISTEMA DE NOTIFICACIONES =====
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ===== FUNCIONES UTILITARIAS =====
        
        function formatDate(dateString) {
            if (!dateString || dateString === 'None') return '-';
            
            // Intenta crear la fecha
            const date = new Date(dateString);
            
            // Si falla, devolvemos el string original o un guion
            if (isNaN(date.getTime())) {
                // Intento extra: Si viene como DD/MM/YYYY (formato latino), JS lo odia.
                // Lo dejamos pasar tal cual si es solo texto visual.
                return dateString; 
            }
            
            return date.toLocaleDateString('es-ES');
        }

        function updateDashboardStats() {
            // ==========================================
            // 1. CÁLCULOS BLINDADOS (NO EXPLOTAN CON DATOS VACÍOS)
            // ==========================================
            if (!currentTickets) return; // Protección básica
            
            const total = currentTickets.length;
            
            // Agentes: Filtramos y contamos
            const agentes = currentUsers.filter(u => 
                (u.rol === 'tech' || u.rol === 'support') && u.estado === 'active'
            ).length;

            // Filtros de estado (Usamos || '' para evitar error en toLowerCase)
            const pendientes = currentTickets.filter(t => 
                ['new', 'pending', 'nuevo', 'pendiente'].includes((t.estado || '').toLowerCase())
            ).length;
            
            const resueltos = currentTickets.filter(t => 
                ['resolved', 'completed', 'closed', 'cerrado', 'resuelto'].includes((t.estado || '').toLowerCase())
            ).length;

            // --- AQUÍ ESTABA EL ERROR ---
            // Antes: t.prioridad.toLowerCase() -> Si era null, explotaba.
            // Ahora: (t.prioridad || '').toLowerCase() -> Si es null, usa texto vacío y sigue vivo.
            const criticos = currentTickets.filter(t => 
                ['high', 'alta', 'critical', 'critica'].includes((t.prioridad || '').toLowerCase()) &&
                !['resolved', 'completed', 'closed', 'cerrado', 'resuelto'].includes((t.estado || '').toLowerCase())
            ).length;

            // ==========================================
            // 2. ACTUALIZAR PANTALLA
            // ==========================================

            // Tarjetas Superiores
            if(document.getElementById('totalTicketsStat')) document.getElementById('totalTicketsStat').textContent = total;
            if(document.getElementById('pendingTicketsStat')) document.getElementById('pendingTicketsStat').textContent = pendientes;
            if(document.getElementById('resolvedTicketsStat')) document.getElementById('resolvedTicketsStat').textContent = resueltos;
            if(document.getElementById('criticalTicketsStat')) document.getElementById('criticalTicketsStat').textContent = criticos;
            
            // Resumen Inferior (Agentes)
            const agentValElement = document.getElementById('summaryAgentsVal');
            if (agentValElement) agentValElement.textContent = agentes;

            // --- CÁLCULOS DE EFICIENCIA ---
            let sumaHoras = 0;
            let ticketsConTiempo = 0;
            let sumaEstrellas = 0;
            let ticketsVotados = 0;

            currentTickets.forEach(t => {
                if (t.horas && parseFloat(t.horas) > 0) {
                    sumaHoras += parseFloat(t.horas);
                    ticketsConTiempo++;
                }
                if (t.calificacion && parseInt(t.calificacion) > 0) {
                    sumaEstrellas += parseInt(t.calificacion);
                    ticketsVotados++;
                }
            });

            const promedioHoras = ticketsConTiempo > 0 ? (sumaHoras / ticketsConTiempo).toFixed(1) + 'h' : '-';
            let satisfaccionPorcentaje = 0;
            if (ticketsVotados > 0) {
                satisfaccionPorcentaje = Math.round((sumaEstrellas / ticketsVotados / 5) * 100);
            }
            const tasaResolucion = total > 0 ? Math.round((resueltos / total) * 100) : 0;

            // Actualizar Métricas KPI
            if(document.getElementById('summaryResolution')) document.getElementById('summaryResolution').textContent = tasaResolucion + '%';
            if(document.getElementById('summaryAvgTime')) document.getElementById('summaryAvgTime').textContent = promedioHoras;
            if(document.getElementById('summarySatisfaction')) document.getElementById('summarySatisfaction').textContent = satisfaccionPorcentaje + '%';
            
            // Actualizar Tarjetas de Gestión
            if(document.getElementById('openTickets')) document.getElementById('openTickets').textContent = pendientes;
            if(document.getElementById('avgResponseTime')) document.getElementById('avgResponseTime').textContent = promedioHoras;
            if(document.getElementById('resolvedTicketsCardValue')) document.getElementById('resolvedTicketsCardValue').textContent = resueltos;
            if(document.getElementById('satisfactionRate')) document.getElementById('satisfactionRate').textContent = satisfaccionPorcentaje + '%';
        }

        function downloadCSV(data, filename) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

    function calculateLeaderboard() {
        // 1. Obtener solo los usuarios con rol 'tech'
        const tecnicos = masterUsers.filter(u => u.rol === 'tech' || u.rol === 'support');
        
        let leaderboardData = [];

        tecnicos.forEach(tech => {
            // 2. Buscar tickets resueltos de este técnico
            const ticketsTecnico = masterTickets.filter(t => 
                t.agente === tech.username && 
                ['resolved', 'completed', 'closed', 'cerrado', 'resuelto'].includes(t.estado.toLowerCase())
            );

            const totalResueltos = ticketsTecnico.length;
            
            // 3. Calcular Tiempo Promedio
            let sumaHoras = 0;
            let ticketsConTiempo = 0;
            
            // 4. Calcular Satisfacción Promedio
            let sumaEstrellas = 0;
            let ticketsConVoto = 0;

            ticketsTecnico.forEach(t => {
                // Tiempo
                if (t.horas && parseFloat(t.horas) > 0) {
                    sumaHoras += parseFloat(t.horas);
                    ticketsConTiempo++;
                }
                // Estrellas
                if (t.calificacion && parseInt(t.calificacion) > 0) {
                    sumaEstrellas += parseInt(t.calificacion);
                    ticketsConVoto++;
                }
            });

            const promedioHoras = ticketsConTiempo > 0 ? (sumaHoras / ticketsConTiempo) : 0;
            const promedioEstrellas = ticketsConVoto > 0 ? (sumaEstrellas / ticketsConVoto) : 0;

            // 5. CALCULAR PUNTAJE (SCORE) PARA EL RANKING
            // Fórmula simple: (Tickets * 10) + (Estrellas * 20) - (Horas * 0.5)
            // Premia cantidad y calidad, penaliza lentitud.
            let score = (totalResueltos * 10) + (promedioEstrellas * 20);
            if (promedioHoras > 0) {
                score -= (promedioHoras * 0.5); // Descuento por tardanza
            }
            if (score < 0) score = 0;

            leaderboardData.push({
                username: tech.username,
                nombre: tech.nombre || tech.username,
                resueltos: totalResueltos,
                tiempo: promedioHoras.toFixed(1) + 'h',
                estrellas: promedioEstrellas.toFixed(1),
                score: Math.round(score)
            });
        });

        // 6. ORDENAR POR PUNTAJE (Mayor a menor)
        leaderboardData.sort((a, b) => b.score - a.score);

        renderLeaderboard(leaderboardData);
    }

    function renderLeaderboard(data) {
        const tbody = document.getElementById('leaderboardBody');
        const podium = document.getElementById('podiumContainer');
        tbody.innerHTML = '';
        podium.innerHTML = '';

        // --- RENDERIZAR TABLA ---
        data.forEach((tech, index) => {
            const rank = index + 1;
            let badge = '';
            
            if (rank === 1) badge = '<i class="fas fa-medal" style="color: #fbbf24; font-size: 1.2rem;"></i>';
            else if (rank === 2) badge = '<i class="fas fa-medal" style="color: #9ca3af; font-size: 1.2rem;"></i>';
            else if (rank === 3) badge = '<i class="fas fa-medal" style="color: #b45309; font-size: 1.2rem;"></i>';
            else badge = `<span style="font-weight:bold; color:var(--text-muted)">${rank}</span>`;

            // Estrellas visuales
            let estrellasVisual = '';
            const stars = Math.round(tech.estrellas);
            for(let i=0; i<5; i++) {
                estrellasVisual += `<i class="fas fa-star" style="color: ${i < stars ? '#fbbf24' : '#e5e7eb'}; font-size: 0.8rem;"></i>`;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="text-align: center;">${badge}</td>
                <td style="font-weight: 600;">${tech.nombre}</td>
                <td style="text-align: center;">
                    <span class="status completed" style="background: rgba(16,185,129,0.1); color:#10b981;">
                        ${tech.resueltos}
                    </span>
                </td>
                <td style="text-align: center;">${tech.tiempo}</td>
                <td style="text-align: center;">
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span style="font-weight:bold;">${tech.estrellas}</span>
                        <div>${estrellasVisual}</div>
                    </div>
                </td>
                <td style="text-align: center; font-weight: 800; color: var(--primary);">${tech.score} pts</td>
            `;
            tbody.appendChild(row);
        });

        // --- RENDERIZAR PODIO (Top 3 Tarjetas) ---
        if (data.length > 0) {
            const top3 = data.slice(0, 3);
            const colors = ['#fbbf24', '#94a3b8', '#b45309']; // Oro, Plata, Bronce
            const titles = ['CAMPEÓN', '2° LUGAR', '3° LUGAR'];

            top3.forEach((tech, i) => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.style.borderTop = `4px solid ${colors[i]}`;
                card.innerHTML = `
                    <div style="font-size: 2.5rem; margin-bottom: 10px; color: ${colors[i]};">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h3 style="margin-bottom: 5px; color: ${colors[i]};">${titles[i]}</h3>
                    <h2 style="margin: 10px 0; font-size: 1.4rem;">${tech.nombre}</h2>
                    <div style="display: flex; justify-content: space-around; margin-top: 15px; width: 100%;">
                        <div style="text-align: center;">
                            <small style="display:block; color:var(--text-muted)">Tickets</small>
                            <strong>${tech.resueltos}</strong>
                        </div>
                        <div style="text-align: center;">
                            <small style="display:block; color:var(--text-muted)">Calif.</small>
                            <strong>${tech.estrellas} ★</strong>
                        </div>
                    </div>
                `;
                podium.appendChild(card);
            });
        }
    }
    function openCategoryModal(id = null) {
        const modal = document.getElementById('categoryModal');
        const title = document.getElementById('categoryModalTitle');
        
        if (id) {
            // Lógica de editar (buscamos la categoria en masterCategories)
            const cat = masterCategories.find(c => c.id === id);
            if(cat) {
                title.textContent = "Editar Categoría";
                document.getElementById('catId').value = cat.id;
                document.getElementById('catNombre').value = cat.nombre;
                document.getElementById('catDescripcion').value = cat.descripcion;
                document.getElementById('catActivo').value = cat.activo.toString();
            }
        } else {
            // Crear nueva
            title.textContent = "Nueva Categoría";
            document.getElementById('categoryForm').reset();
            document.getElementById('catId').value = '';
        }
        modal.classList.add('active');
    }

    function closeCategoryModal() {
        document.getElementById('categoryModal').classList.remove('active');
    }
    
    // Función global para el botón editar de la tabla
    window.editCategory = function(id) {
        openCategoryModal(id);
        }

    // ===== GESTIÓN DE ÁREAS (CORREGIDO) =====

    function loadAreasData() {
        const tbody = document.getElementById('areasBody');
        if (!tbody) return; // Si no estamos en la pestaña correcta, salir
        
        tbody.innerHTML = '';

        const totalAreas = masterAreas ? masterAreas.length : 0;
        const totalPages = Math.ceil(totalAreas / ITEMS_PER_PAGE);
        if (totalPages > 0 && currentPage.areas > totalPages) {
            currentPage.areas = totalPages;
        } else if (totalAreas === 0) {
            currentPage.areas = 1;
        }

        // Verificar si hay datos
        if (!masterAreas || masterAreas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#94a3b8;">No hay áreas registradas. Crea la primera.</td></tr>';
            renderPaginationControls(totalAreas, currentPage.areas, 'areasPagination', 'areas');
            return;
        }

        const pageData = paginateData(masterAreas, currentPage.areas);

        pageData.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${a.id}</strong></td>
                <td>${a.nombre}</td>
                <td>${a.descripcion || '-'}</td>
                <td class="action-buttons">
                    <button class="action-btn edit" onclick="editArea(${a.id})" title="Editar Área">
                        <i class="fas fa-edit"></i> EDITAR
                    </button>
                    <a href="/area/eliminar/${a.id}/" class="action-btn delete" onclick="return confirm('¿Estás seguro de eliminar el área ${a.nombre}?')" title="Eliminar" style="text-decoration:none; display:inline-flex; align-items:center; gap:5px;">
                        <i class="fas fa-trash"></i> BORRAR
                    </a>
                </td>
            `;
            tbody.appendChild(tr);
        });

        renderPaginationControls(masterAreas.length, currentPage.areas, 'areasPagination', 'areas');
    }

    function openAreaModal(id = null) {
        const modal = document.getElementById('areaModal');
        if (!modal) {
            console.error("Error: No se encontró el modal 'areaModal'");
            return;
        }

        // Resetear formulario
        document.getElementById('areaId').value = '';
        document.getElementById('areaNombre').value = '';
        document.getElementById('areaDescripcion').value = '';
        document.getElementById('areaModalTitle').textContent = 'Nueva Área';
        
        // Si es edición, llenar datos
        if (id) {
            const area = masterAreas.find(a => a.id === id);
            if (area) {
                document.getElementById('areaId').value = area.id;
                document.getElementById('areaNombre').value = area.nombre;
                document.getElementById('areaDescripcion').value = area.descripcion;
                document.getElementById('areaModalTitle').textContent = 'Editar Área';
            }
        }
        
        modal.classList.add('active');
    }

    function closeAreaModal() {
        const modal = document.getElementById('areaModal');
        if (modal) modal.classList.remove('active');
    }
    
    // Hacemos la función global para que el botón onclick la encuentre
    window.editArea = function(id) {
        openAreaModal(id);
    };

    function loadFaqData() {
        const container = document.getElementById('faqContainer');
        container.innerHTML = '';
        if(masterFaqs.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay FAQs registradas.</p>';
            return;
        }
        masterFaqs.forEach(faq => {
            const item = document.createElement('div');
            item.style.borderBottom = '1px solid #eee';
            item.style.padding = '15px 0';
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <details style="flex: 1;">
                        <summary style="font-weight: 600; cursor: pointer; color: var(--text-light);">
                            <i class="fas fa-chevron-right" style="color: var(--primary); margin-right: 5px;"></i> ${faq.pregunta}
                        </summary>
                        <p style="margin-top: 10px; color: var(--text-muted); padding-left: 20px;">${faq.respuesta}</p>
                    </details>
                    <div style="min-width: 80px; text-align: right;">
                        <button class="action-btn edit" onclick="editFaq(${faq.id})"><i class="fas fa-edit"></i></button>
                        <a href="/faq/eliminar/${faq.id}/" class="action-btn delete" onclick="return confirm('¿Eliminar?')"><i class="fas fa-trash"></i></a>
                    </div>
                </div>`;
            container.appendChild(item);
        });
    }

    function openFaqModal(id = null) {
        const modal = document.getElementById('faqModal');
        const title = document.getElementById('faqModalTitle');
        document.getElementById('faqId').value = '';
        document.getElementById('faqPregunta').value = '';
        document.getElementById('faqRespuesta').value = '';

        if(id) {
            const faq = masterFaqs.find(f => f.id === id);
            if(faq) {
                title.textContent = 'Editar Pregunta';
                document.getElementById('faqId').value = faq.id;
                document.getElementById('faqPregunta').value = faq.pregunta;
                document.getElementById('faqRespuesta').value = faq.respuesta;
            }
        } else {
            title.textContent = 'Nueva Pregunta';
        }
        modal.classList.add('active');
    }

    function closeFaqModal() { document.getElementById('faqModal').classList.remove('active'); }
    window.editFaq = function(id) { openFaqModal(id); }

    </script>

    {% if messages %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% for message in messages %}
                // Llamamos a tu función JS existente showNotification
                // Mapeamos los tags de Django (error/success) a los tuyos
                setTimeout(function() {
                    // Agregamos |escapejs para que se vea bien la comilla
                    showNotification("{{ message|escapejs }}", "{{ message.tags }}");
                }, 500 * {{ forloop.counter }}); // Pequeño delay para que no salgan todos juntos si hay varios
            {% endfor %}
        });
    </script>
    {% endif %}
</body>
</html>